/**
 * å±å¹•å…±äº«çŠ¶æ€ç®¡ç† - é›†æˆåˆ°OpenAvatarChat-WebUI
 * åŸºäºç°æœ‰videoChatStoreæ¶æ„æ‰©å±•
 */

import { defineStore } from 'pinia';
import { ref, computed } from 'vue';
import { message } from 'ant-design-vue';
import { 
  getOptimizedDisplayStream, 
  ConnectionMonitor,
  type ConnectionQuality,
  checkScreenShareSupport,
  type ScreenShareOptions 
} from '@/utils/screenShareUtils';
import { useVideoChatStore } from './index';

interface ScreenShareState {
  // åŸºç¡€çŠ¶æ€
  isScreenSharing: boolean;
  screenShareStream: MediaStream | null;
  screenShareSupported: boolean;
  currentVideoSource: 'camera' | 'screen';
  
  // è¿æ¥çŠ¶æ€
  connectionState: RTCIceConnectionState;
  connectionQuality: ConnectionQuality;
  
  // æ€§èƒ½ç›‘æ§
  connectionStats: {
    bytesReceived: number;
    bytesSent: number;
    packetsLost: number;
    roundTripTime: number;
    bandwidth: number;
  };
  
  // ç”¨æˆ·é€‰é¡¹
  screenShareOptions: {
    quality: 'ai-compatible' | 'mobile' | 'desktop' | 'high-bandwidth';
    includeSystemAudio: boolean;
    captureMode: 'desktop' | 'window' | 'tab';
    autoQualityAdjust: boolean;
  };
  
  // é”™è¯¯çŠ¶æ€
  lastError: string | null;
  
  // UIçŠ¶æ€
  showSettingsPanel: boolean;
  showStatsPanel: boolean;
}

export const useScreenShareStore = defineStore('screenShareStore', () => {
  // å“åº”å¼çŠ¶æ€
  const state = ref<ScreenShareState>({
    isScreenSharing: false,
    screenShareStream: null,
    screenShareSupported: false,
    currentVideoSource: 'camera',
    
    connectionState: 'new',
    connectionQuality: 'good',
    
    connectionStats: {
      bytesReceived: 0,
      bytesSent: 0,
      packetsLost: 0,
      roundTripTime: 0,
      bandwidth: 0
    },
    
    screenShareOptions: {
      quality: 'ai-compatible',  // ğŸ¯ é»˜è®¤ä½¿ç”¨AIå…¼å®¹æ¨¡å¼
      includeSystemAudio: false,
      captureMode: 'window',
      autoQualityAdjust: true
    },
    
    lastError: null,
    showSettingsPanel: false,
    showStatsPanel: false
  });
  
  // è®¡ç®—å±æ€§
  const isConnected = computed(() => 
    state.value.connectionState === 'connected'
  );
  
  const canStartScreenShare = computed(() => 
    state.value.screenShareSupported && 
    !state.value.isScreenSharing &&
    state.value.connectionState !== 'checking'
  );
  
  const isMobile = computed(() => 
    /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
  );
  
  const qualityText = computed(() => {
    switch (state.value.connectionQuality) {
      case 'excellent': return 'ä¼˜ç§€';
      case 'good': return 'è‰¯å¥½';
      case 'fair': return 'ä¸€èˆ¬';
      case 'poor': return 'è¾ƒå·®';
      default: return 'æœªçŸ¥';
    }
  });
  
  const connectionStatusText = computed(() => {
    switch (state.value.connectionState) {
      case 'connected': return 'å·²è¿æ¥åˆ°TURNæœåŠ¡å™¨';
      case 'checking': return 'æ­£åœ¨è¿æ¥TURNæœåŠ¡å™¨...';
      case 'disconnected': return 'TURNè¿æ¥æ–­å¼€';
      case 'failed': return 'TURNè¿æ¥å¤±è´¥';
      default: return 'å‡†å¤‡å°±ç»ª';
    }
  });
  
  // WebRTCç›¸å…³å®ä¾‹
  let peerConnection: RTCPeerConnection | null = null;
  let connectionMonitor: ConnectionMonitor | null = null;
  
  // ğŸ“· æ‘„åƒå¤´çŠ¶æ€è®°å¿†ï¼ˆç”¨äºå±å¹•å…±äº«æ—¶è‡ªåŠ¨ç®¡ç†æ‘„åƒå¤´ï¼‰
  let cameraDisplayStateBeforeScreenShare: boolean = false;  // è®°å¿†ç”¨æˆ·åŸæœ¬çš„æ˜¾ç¤ºçŠ¶æ€
  
  /**
   * åˆå§‹åŒ–å±å¹•å…±äº«åŠŸèƒ½
   */
  async function initializeScreenShare(): Promise<boolean> {
    const supportCheck = checkScreenShareSupport();
    state.value.screenShareSupported = supportCheck.supported;
    
    // ğŸ› è¯¦ç»†å±å¹•å…±äº«æ”¯æŒæ£€æµ‹æ—¥å¿—
    console.log('ğŸ” å±å¹•å…±äº«æ”¯æŒæ£€æµ‹:', {
      æµè§ˆå™¨: navigator.userAgent,
      è®¾å¤‡ç±»å‹: /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ? 'ğŸ“± ç§»åŠ¨è®¾å¤‡' : 'ğŸ’» æ¡Œé¢è®¾å¤‡',
      æ”¯æŒçŠ¶æ€: supportCheck.supported,
      ä¸æ”¯æŒåŸå› : supportCheck.reason || 'æ— ',
      getDisplayMediaå¯ç”¨: !!navigator.mediaDevices?.getDisplayMedia,
      navigatorå¯ç”¨: !!navigator.mediaDevices,
      HTTPSåè®®: location.protocol === 'https:',
      æœ¬åœ°ç¯å¢ƒ: location.hostname === 'localhost'
    });
    
    if (!supportCheck.supported) {
      console.warn('âš ï¸ å±å¹•å…±äº«ä¸æ”¯æŒ:', supportCheck.reason);
      state.value.lastError = supportCheck.reason || 'æµè§ˆå™¨ä¸æ”¯æŒå±å¹•å…±äº«';
      return false;
    }
    
    state.value.lastError = null;
    console.log('âœ… å±å¹•å…±äº«åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
    return true;
  }
  
  /**
   * è®¾ç½®PeerConnectionï¼ˆä»videoChatStoreè·å–ï¼‰
   */
  function setPeerConnection(pc: RTCPeerConnection) {
    peerConnection = pc;
    console.log('ğŸ”Œ PeerConnectionå·²è®¾ç½®åˆ°screenShareStore:', {
      connectionState: pc.connectionState,
      iceConnectionState: pc.iceConnectionState,
      sendersCount: pc.getSenders().length
    });
    setupPeerConnectionEvents();
  }
  
  /**
   * è®¾ç½®PeerConnectionäº‹ä»¶ç›‘å¬
   */
  function setupPeerConnectionEvents() {
    if (!peerConnection) return;
    
    peerConnection.addEventListener('iceconnectionstatechange', () => {
      state.value.connectionState = peerConnection!.iceConnectionState;
      console.log('ğŸ”— ICEè¿æ¥çŠ¶æ€:', state.value.connectionState);
    });
  }

  /**
   * å¼€å§‹å±å¹•å…±äº«
   */
  async function startScreenShare(): Promise<void> {
    if (!state.value.screenShareSupported) {
      throw new Error('æµè§ˆå™¨ä¸æ”¯æŒå±å¹•å…±äº«');
    }
    
    if (state.value.isScreenSharing) {
      console.log('âš ï¸ å±å¹•å…±äº«å·²ç»åœ¨è¿›è¡Œä¸­');
      return;
    }

    try {
      console.log('ğŸš€ å¼€å§‹å±å¹•å…±äº«...');
      state.value.lastError = null;
      
      // ğŸ“· æ™ºèƒ½æ‘„åƒå¤´çŠ¶æ€ç®¡ç†ï¼šè®°å¿†çŠ¶æ€å¹¶ç¡®ä¿è½¨é“å¯ç”¨
      const videoChatStore = useVideoChatStore();
      
      // è®°å¿†ç”¨æˆ·åŸæœ¬çš„æ‘„åƒå¤´çŠ¶æ€ï¼ˆtrueè¡¨ç¤ºæ˜¾ç¤ºå¼€å¯ï¼Œfalseè¡¨ç¤ºæ˜¾ç¤ºå…³é—­ï¼‰
      cameraDisplayStateBeforeScreenShare = !videoChatStore.cameraOff;
      
      console.log('ğŸ“· å±å¹•å…±äº«å¼€å§‹å‰çš„æ‘„åƒå¤´çŠ¶æ€:', {
        cameraOff: videoChatStore.cameraOff,
        ç”¨æˆ·åŸæœ¬æ˜¾ç¤ºçŠ¶æ€: cameraDisplayStateBeforeScreenShare ? 'å¼€å¯æ˜¾ç¤º' : 'å…³é—­æ˜¾ç¤º',
        localStreamå­˜åœ¨: !!videoChatStore.localStream,
        è§†é¢‘è½¨é“æ•°é‡: videoChatStore.localStream?.getVideoTracks().length || 0
      });
      
      // ğŸ¯ å…³é”®ä¿®å¤ï¼šç¡®ä¿æ‘„åƒå¤´è½¨é“å¯ç”¨ä»¥æ”¯æŒWebRTCè½¨é“æ›¿æ¢
      if (videoChatStore.cameraOff) {
        console.log('ğŸ”§ ç”¨æˆ·æ‘„åƒå¤´åŸæœ¬æ˜¯å…³é—­çš„ï¼Œç°åœ¨è‡ªåŠ¨å¯ç”¨è½¨é“ä»¥æ”¯æŒå±å¹•å…±äº«');
        videoChatStore.handleCameraOff(); // åˆ‡æ¢åˆ°å¼€å¯çŠ¶æ€ï¼ˆcameraOff = falseï¼Œè½¨é“å¯ç”¨ï¼‰
      }
      
      // æ­¤æ—¶ cameraOff = falseï¼Œè½¨é“å·²å¯ç”¨ï¼Œä½†ä¸ºäº†é¿å…ç”¨æˆ·çœ‹åˆ°è‡ªå·±ï¼Œå†æ¬¡å…³é—­æ˜¾ç¤º
      console.log('ğŸ“· éšè—æ‘„åƒå¤´æ˜¾ç¤ºï¼ˆä½†ä¿æŒè½¨é“å¯ç”¨çŠ¶æ€ï¼‰');
      videoChatStore.handleCameraOff(); // åˆ‡æ¢åˆ°å…³é—­çŠ¶æ€ï¼ˆcameraOff = trueï¼Œä½†ä¹‹å‰çš„è½¨é“æ›¿æ¢ä¼šä¿æŒå±å¹•æµï¼‰
      
      // è·å–å±å¹•å…±äº«æµ
      const displayStream = await getOptimizedDisplayStream({
        video: true,
        audio: state.value.screenShareOptions.includeSystemAudio,
        quality: state.value.screenShareOptions.quality,
        turnOptimized: true
      });
      
      // æ›´æ–°çŠ¶æ€
      state.value.screenShareStream = displayStream;
      state.value.isScreenSharing = true;
      state.value.currentVideoSource = 'screen';
      
      // ğŸ”¥ğŸ”¥ğŸ”¥ å…³é”®ä¿®å¤ï¼šå°†å±å¹•è§†é¢‘æµæ›¿æ¢åˆ°WebRTCè¿æ¥ä¸­
      // è¿™æ ·AIå°±èƒ½çœ‹åˆ°å±å¹•å†…å®¹è€Œä¸æ˜¯æ‘„åƒå¤´äº†ï¼
      console.log('ğŸ› å‡†å¤‡æ›¿æ¢è§†é¢‘è½¨é“...', {
        displayStreamTracks: displayStream.getTracks().length,
        peerConnectionExists: !!peerConnection,
        å±å¹•æµè¯¦æƒ…: {
          id: displayStream.id,
          active: displayStream.active,
          videoTracks: displayStream.getVideoTracks().map(track => ({
            label: track.label,
            enabled: track.enabled,
            readyState: track.readyState,
            muted: track.muted,
            settings: track.getSettings()
          }))
        }
      });
      
      try {
        // ğŸ¯ æ–°å¢ï¼šéªŒè¯å±å¹•æ•è·å†…å®¹
        const videoTrack = displayStream.getVideoTracks()[0];
        if (!videoTrack || videoTrack.readyState !== 'live') {
          throw new Error(`å±å¹•è§†é¢‘è½¨é“çŠ¶æ€å¼‚å¸¸: ${videoTrack ? videoTrack.readyState : 'no track'}`);
        }
        
        // ğŸ¯ æ–°å¢ï¼šç­‰å¾…è½¨é“æ•°æ®ç¨³å®š
        console.log('â³ ç­‰å¾…å±å¹•æ•è·æ•°æ®ç¨³å®š...');
        await new Promise(resolve => setTimeout(resolve, 500)); // ç­‰å¾…500msè®©æ•°æ®æµç¨³å®š
        
        // ğŸ¯ æ–°å¢ï¼šæµ‹è¯•å±å¹•æ•è·å†…å®¹æ˜¯å¦ä¸ºç©º
        const isContentValid = await testScreenShareContent(displayStream);
        console.log('ğŸ“Š å±å¹•å†…å®¹éªŒè¯ç»“æœ:', isContentValid);
        
        if (!isContentValid.hasContent) {
          console.warn('âš ï¸ å±å¹•æ•è·å¯èƒ½ä¸ºç©ºæˆ–é»‘å±:', isContentValid.reason);
          // ä¸æŠ›å‡ºé”™è¯¯ï¼Œä½†è®°å½•è­¦å‘Šï¼Œå› ä¸ºæœ‰äº›æƒ…å†µä¸‹é»‘å±æ˜¯æ­£å¸¸çš„ï¼ˆæ¯”å¦‚æ˜¾ç¤ºé»‘è‰²èƒŒæ™¯ï¼‰
        }
        
        await replaceVideoTrack(displayStream);
        console.log('ğŸ‰ æˆåŠŸï¼å±å¹•å†…å®¹ç°åœ¨ä¼ é€ç»™AIäº†ï¼ŒAIå¯ä»¥çœ‹åˆ°ä½ çš„å±å¹•ï¼');
        
        // ğŸ¯ æ–°å¢ï¼šéªŒè¯æ›¿æ¢åçš„è½¨é“çŠ¶æ€å¹¶é€šçŸ¥AI
        setTimeout(async () => {
          const sender = peerConnection?.getSenders().find(s => s.track?.kind === 'video');
          if (sender && sender.track) {
            console.log('ğŸ” æ›¿æ¢åè½¨é“éªŒè¯:', {
              label: sender.track.label,
              enabled: sender.track.enabled,
              readyState: sender.track.readyState,
              muted: sender.track.muted,
              settings: sender.track.getSettings(),
              stats: sender.track.getSettings()
            });
            
            // ğŸ¯ å‘é€å±å¹•å…±äº«ä¸Šä¸‹æ–‡æç¤ºç»™AI
            if (sender.track.label.includes('screen')) {
              console.log('ğŸ“¢ å‘AIå‘é€å±å¹•å…±äº«ä¸Šä¸‹æ–‡æç¤º');
              await notifyAIAboutScreenShare(true);
            }
          }
        }, 1000);
        
      } catch (error) {
        console.error('âŒ è½¨é“æ›¿æ¢å¤±è´¥:', error);
        throw error;
      }
      
      // ç›‘å¬æµç»“æŸäº‹ä»¶
      displayStream.getVideoTracks()[0].addEventListener('ended', () => {
        console.log('ğŸ›‘ å±å¹•å…±äº«æµç»“æŸ');
        stopScreenShare();
      });
      
      // å¯åŠ¨è¿æ¥è´¨é‡ç›‘æ§
      if (peerConnection) {
        connectionMonitor = new ConnectionMonitor(
          peerConnection,
          (quality) => {
            state.value.connectionQuality = quality;
            
            if (state.value.screenShareOptions.autoQualityAdjust && quality === 'poor') {
              console.log('ğŸ“‰ è¿æ¥è´¨é‡å·®ï¼Œè‡ªåŠ¨é™ä½è´¨é‡');
              adjustQualityForPoorConnection();
            }
          }
        );
      }
      
      message.success('å±å¹•å…±äº«å¯åŠ¨æˆåŠŸ');
      console.log('âœ… å±å¹•å…±äº«å¯åŠ¨æˆåŠŸ');

    } catch (error: any) {
      console.error('âŒ å±å¹•å…±äº«å¯åŠ¨å¤±è´¥:', error);
      state.value.lastError = error.message || 'å±å¹•å…±äº«å¯åŠ¨å¤±è´¥';
      
      // ğŸ“· å±å¹•å…±äº«å¯åŠ¨å¤±è´¥æ—¶æ¢å¤æ‘„åƒå¤´çŠ¶æ€
      if (cameraDisplayStateBeforeScreenShare) {
        const videoChatStore = useVideoChatStore();
        if (videoChatStore.cameraOff) {
          console.log('ğŸ“· å±å¹•å…±äº«å¤±è´¥ï¼Œæ¢å¤æ‘„åƒå¤´æ˜¾ç¤ºçŠ¶æ€');
          videoChatStore.handleCameraOff(); // æ¢å¤æ‘„åƒå¤´æ˜¾ç¤º
        }
      }
      
      // æ¸…ç†çŠ¶æ€
      state.value.isScreenSharing = false;
      state.value.screenShareStream = null;
      state.value.currentVideoSource = 'camera';
      
      message.error(`å±å¹•å…±äº«å¯åŠ¨å¤±è´¥: ${error.message}`);
      throw error;
    }
  }
  
  /**
   * åœæ­¢å±å¹•å…±äº«
   */
  async function stopScreenShare(): Promise<void> {
    if (!state.value.isScreenSharing) {
      console.log('âš ï¸ å±å¹•å…±äº«æœªåœ¨è¿›è¡Œä¸­');
      return;
    }
    
    try {
      console.log('ğŸ›‘ åœæ­¢å±å¹•å…±äº«...');
      
      // åœæ­¢æµ
      if (state.value.screenShareStream) {
        state.value.screenShareStream.getTracks().forEach(track => {
          track.stop();
        });
      }
      
      // åœæ­¢è¿æ¥ç›‘æ§
      if (connectionMonitor) {
        connectionMonitor.stopMonitoring();
        connectionMonitor = null;
      }
      
      // ğŸ”¥ğŸ”¥ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ¢å¤æ‘„åƒå¤´è½¨é“ï¼Œè®©AIé‡æ–°çœ‹åˆ°æ‘„åƒå¤´ç”»é¢
      const videoChatStore = useVideoChatStore();
      if (videoChatStore.localStream) {
        await replaceVideoTrack(videoChatStore.localStream);
        console.log('ğŸ‰ å·²æ¢å¤æ‘„åƒå¤´è½¨é“ï¼ŒAIç°åœ¨é‡æ–°çœ‹åˆ°æ‘„åƒå¤´ç”»é¢ï¼');
        
        // ğŸ¯ é€šçŸ¥AIå±å¹•å…±äº«å·²ç»“æŸ
        setTimeout(async () => {
          console.log('ğŸ“¢ å‘AIå‘é€å±å¹•å…±äº«ç»“æŸæç¤º');
          await notifyAIAboutScreenShare(false);
        }, 500);
        
      } else {
        console.warn('âš ï¸ æ— æ³•æ¢å¤æ‘„åƒå¤´è½¨é“ï¼šlocalStreamä¸å­˜åœ¨');
      }
      
      // ğŸ“· æ™ºèƒ½æ¢å¤æ‘„åƒå¤´çŠ¶æ€
      console.log('ğŸ“· æ¢å¤æ‘„åƒå¤´åˆ°åŸå§‹çŠ¶æ€:', {
        ç”¨æˆ·åŸæœ¬æ˜¾ç¤ºçŠ¶æ€: cameraDisplayStateBeforeScreenShare ? 'å¼€å¯æ˜¾ç¤º' : 'å…³é—­æ˜¾ç¤º',
        å½“å‰cameraOff: videoChatStore.cameraOff,
        éœ€è¦æ¢å¤: cameraDisplayStateBeforeScreenShare && videoChatStore.cameraOff
      });
      
      if (cameraDisplayStateBeforeScreenShare && videoChatStore.cameraOff) {
        console.log('ğŸ“· ç”¨æˆ·åŸæœ¬å¼€å¯äº†æ‘„åƒå¤´æ˜¾ç¤ºï¼Œç°åœ¨è‡ªåŠ¨æ¢å¤');
        videoChatStore.handleCameraOff(); // æ¢å¤åˆ°æ˜¾ç¤ºå¼€å¯çŠ¶æ€
      } else if (!cameraDisplayStateBeforeScreenShare && !videoChatStore.cameraOff) {
        console.log('ğŸ“· ç”¨æˆ·åŸæœ¬å…³é—­äº†æ‘„åƒå¤´æ˜¾ç¤ºï¼Œç°åœ¨è‡ªåŠ¨æ¢å¤åˆ°å…³é—­çŠ¶æ€');
        videoChatStore.handleCameraOff(); // æ¢å¤åˆ°æ˜¾ç¤ºå…³é—­çŠ¶æ€
      }
      
      // æ›´æ–°çŠ¶æ€
      state.value.screenShareStream = null;
      state.value.isScreenSharing = false;
      state.value.currentVideoSource = 'camera';
      state.value.lastError = null;
      
      message.success('å±å¹•å…±äº«å·²åœæ­¢');
      console.log('âœ… å±å¹•å…±äº«å·²åœæ­¢');

    } catch (error: any) {
      console.error('âŒ åœæ­¢å±å¹•å…±äº«å¤±è´¥:', error);
      state.value.lastError = error.message || 'åœæ­¢å±å¹•å…±äº«å¤±è´¥';
      message.error(`åœæ­¢å±å¹•å…±äº«å¤±è´¥: ${error.message}`);
      throw error;
    }
  }
  
  /**
   * åˆ‡æ¢å±å¹•å…±äº«çŠ¶æ€
   */
  async function toggleScreenShare(): Promise<void> {
    if (state.value.isScreenSharing) {
      await stopScreenShare();
    } else {
      await startScreenShare();
    }
  }
  
  /**
   * è¿æ¥è´¨é‡å·®æ—¶è‡ªåŠ¨è°ƒæ•´
   */
  function adjustQualityForPoorConnection() {
    const currentQuality = state.value.screenShareOptions.quality;
    
    if (currentQuality === 'high-bandwidth') {
      updateScreenShareOptions({ quality: 'desktop' });
    } else if (currentQuality === 'desktop') {
      updateScreenShareOptions({ quality: 'ai-compatible' });
    } else if (currentQuality === 'ai-compatible') {
      updateScreenShareOptions({ quality: 'mobile' });
    }
    // mobileå·²ç»æ˜¯æœ€ä½è´¨é‡ï¼Œä¸å†é™ä½
    
    console.log(`ğŸ“Š è´¨é‡å·²è°ƒæ•´ä¸º: ${state.value.screenShareOptions.quality}`);
  }
  
  /**
   * æ›´æ–°å±å¹•å…±äº«é€‰é¡¹
   */
  function updateScreenShareOptions(options: Partial<typeof state.value.screenShareOptions>) {
    state.value.screenShareOptions = {
      ...state.value.screenShareOptions,
      ...options
    };
    
    console.log('âš™ï¸ å±å¹•å…±äº«é€‰é¡¹å·²æ›´æ–°:', state.value.screenShareOptions);
  }
  
  /**
   * åˆ‡æ¢è®¾ç½®é¢æ¿
   */
  function toggleSettingsPanel() {
    state.value.showSettingsPanel = !state.value.showSettingsPanel;
    if (state.value.showSettingsPanel) {
      state.value.showStatsPanel = false;
    }
  }
  
  /**
   * åˆ‡æ¢ç»Ÿè®¡é¢æ¿
   */
  function toggleStatsPanel() {
    state.value.showStatsPanel = !state.value.showStatsPanel;
    if (state.value.showStatsPanel) {
      state.value.showSettingsPanel = false;
    }
  }
  
  /**
   * æ¸…é™¤é”™è¯¯çŠ¶æ€
   */
  function clearError() {
    state.value.lastError = null;
  }
  
  /**
   * é€šçŸ¥AIå±å¹•å…±äº«çŠ¶æ€å˜åŒ–
   */
  async function notifyAIAboutScreenShare(isScreenSharing: boolean) {
    try {
      const videoChatStore = useVideoChatStore();
      
      if (!videoChatStore.chatDataChannel || videoChatStore.chatDataChannel.readyState !== 'open') {
        console.log('ğŸ“¡ èŠå¤©æ•°æ®é€šé“æœªå°±ç»ªï¼Œè·³è¿‡AIé€šçŸ¥');
        return;
      }
      
      const contextMessage = isScreenSharing 
        ? "ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·ç°åœ¨å¼€å§‹äº†å±å¹•å…±äº«ï¼Œä½ ç°åœ¨çœ‹åˆ°çš„æ˜¯ç”¨æˆ·çš„å±å¹•å†…å®¹ï¼Œè¯·æ ¹æ®å±å¹•å†…å®¹è¿›è¡Œåˆ†æå’Œå›åº”ã€‚"
        : "ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·ç»“æŸäº†å±å¹•å…±äº«ï¼Œä½ ç°åœ¨çœ‹åˆ°çš„æ˜¯ç”¨æˆ·çš„æ‘„åƒå¤´ç”»é¢ã€‚";
      
      // é€šè¿‡æ•°æ®é€šé“å‘é€ä¸Šä¸‹æ–‡æ¶ˆæ¯
      const message = {
        type: 'context_update',
        content: contextMessage,
        timestamp: Date.now(),
        source: 'screen_share_system'
      };
      
      console.log('ğŸ“¤ å‘é€AIä¸Šä¸‹æ–‡æ¶ˆæ¯:', contextMessage);
      videoChatStore.chatDataChannel.send(JSON.stringify(message));
      
    } catch (error) {
      console.error('âŒ å‘é€AIé€šçŸ¥å¤±è´¥:', error);
      // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå› ä¸ºè¿™ä¸æ˜¯å…³é”®åŠŸèƒ½
    }
  }

  /**
   * æµ‹è¯•å±å¹•å…±äº«å†…å®¹æ˜¯å¦æœ‰æ•ˆï¼ˆéç©ºã€éé»‘å±ï¼‰
   */
  async function testScreenShareContent(stream: MediaStream): Promise<{hasContent: boolean, reason: string, details?: any}> {
    try {
      // åˆ›å»ºè§†é¢‘å…ƒç´ æ¥æ’­æ”¾æµ
      const video = document.createElement('video');
      video.srcObject = stream;
      video.muted = true;
      video.width = 320;
      video.height = 240;
      
      // ç­‰å¾…è§†é¢‘å‡†å¤‡å°±ç»ª
      await new Promise((resolve, reject) => {
        video.onloadedmetadata = resolve;
        video.onerror = reject;
        video.play();
      });
      
      // ç­‰å¾…ä¸€å¸§æ¸²æŸ“
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // åˆ›å»ºcanvasè¿›è¡Œåƒç´ åˆ†æ
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      if (!ctx) {
        return { hasContent: false, reason: 'Canvas contextä¸å¯ç”¨' };
      }
      
      canvas.width = video.videoWidth || 320;
      canvas.height = video.videoHeight || 240;
      
      // ç»˜åˆ¶å½“å‰å¸§åˆ°canvas
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      // è·å–åƒç´ æ•°æ®
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const pixels = imageData.data;
      
      // åˆ†æåƒç´ å†…å®¹
      let totalBrightness = 0;
      let nonZeroPixels = 0;
      const sampleRate = 10; // æ¯10ä¸ªåƒç´ é‡‡æ ·ä¸€ä¸ªï¼Œæé«˜æ€§èƒ½
      
      for (let i = 0; i < pixels.length; i += 4 * sampleRate) {
        const r = pixels[i];
        const g = pixels[i + 1]; 
        const b = pixels[i + 2];
        const brightness = (r + g + b) / 3;
        
        totalBrightness += brightness;
        if (brightness > 0) {
          nonZeroPixels++;
        }
      }
      
      const avgBrightness = totalBrightness / (pixels.length / 4 / sampleRate);
      const nonZeroRatio = nonZeroPixels / (pixels.length / 4 / sampleRate);
      
      const details = {
        videoWidth: video.videoWidth,
        videoHeight: video.videoHeight,
        avgBrightness: avgBrightness.toFixed(2),
        nonZeroRatio: nonZeroRatio.toFixed(3),
        sampledPixels: pixels.length / 4 / sampleRate
      };
      
      // æ¸…ç†èµ„æº
      video.srcObject = null;
      
      // åˆ¤æ–­æ˜¯å¦æœ‰å†…å®¹
      // å¦‚æœå¹³å‡äº®åº¦å¤ªä½ä¸”å¤§éƒ¨åˆ†åƒç´ ä¸º0ï¼Œå¯èƒ½æ˜¯é»‘å±
      if (avgBrightness < 5 && nonZeroRatio < 0.1) {
        return { hasContent: false, reason: 'æ£€æµ‹åˆ°é»‘å±æˆ–ææš—å†…å®¹', details };
      }
      
      // å¦‚æœæ‰€æœ‰åƒç´ éƒ½æ˜¯åŒä¸€å€¼ï¼Œå¯èƒ½æ˜¯çº¯è‰²å±å¹•
      if (nonZeroRatio === 0) {
        return { hasContent: false, reason: 'æ£€æµ‹åˆ°å…¨é»‘å±å¹•', details };
      }
      
      return { hasContent: true, reason: 'æ£€æµ‹åˆ°æœ‰æ•ˆå±å¹•å†…å®¹', details };
      
    } catch (error) {
      console.error('å±å¹•å†…å®¹æµ‹è¯•å¤±è´¥:', error);
      return { 
        hasContent: true, 
        reason: 'æµ‹è¯•å¤±è´¥ï¼Œå‡è®¾å†…å®¹æœ‰æ•ˆ', 
        details: { 
          error: error instanceof Error ? error.message : String(error)
        } 
      };
    }
  }

  /**
   * æ›¿æ¢è§†é¢‘è½¨é“ï¼ˆç”¨äºåœ¨æ‘„åƒå¤´å’Œå±å¹•ä¹‹é—´åˆ‡æ¢ï¼‰
   */
  async function replaceVideoTrack(newStream: MediaStream): Promise<void> {
    if (!peerConnection) {
      console.error('âŒ æ— æ³•æ›¿æ¢è§†é¢‘è½¨é“ï¼špeerConnectionä¸å­˜åœ¨');
      return;
    }
    
    const sender = peerConnection.getSenders().find(s => s.track?.kind === 'video');
    if (sender && newStream.getVideoTracks().length > 0) {
      const newTrack = newStream.getVideoTracks()[0];
      const oldTrack = sender.track;
      
      // ğŸ› è¯¦ç»†è°ƒè¯•ä¿¡æ¯
      console.log('ğŸ” è½¨é“æ›¿æ¢è¯¦æƒ…:', {
        oldTrack: oldTrack?.label || 'none',
        oldTrackEnabled: oldTrack?.enabled,
        oldTrackReadyState: oldTrack?.readyState,
        newTrack: newTrack.label,
        newTrackEnabled: newTrack.enabled,
        newTrackMuted: newTrack.muted,
        newTrackReadyState: newTrack.readyState,
        newTrackSettings: newTrack.getSettings(),
        // ğŸ¯ æ–°å¢ï¼šæ£€æŸ¥æµçš„æ´»è·ƒçŠ¶æ€
        streamActive: newStream.active,
        streamId: newStream.id
      });
      
      // ğŸ¯ æ–°å¢ï¼šæ›¿æ¢å‰éªŒè¯æ–°è½¨é“çš„å¥åº·çŠ¶æ€
      if (newTrack.readyState !== 'live') {
        console.warn('âš ï¸ æ–°è½¨é“çŠ¶æ€ä¸æ˜¯live:', newTrack.readyState);
      }
      
      if (newTrack.muted) {
        console.warn('âš ï¸ æ–°è½¨é“è¢«é™éŸ³');
      }
      
      // æ‰§è¡Œæ›¿æ¢
      console.log('ğŸ”„ æ­£åœ¨æ‰§è¡Œè½¨é“æ›¿æ¢...');
      await sender.replaceTrack(newTrack);
      console.log('ğŸ“¹ è§†é¢‘è½¨é“å·²æˆåŠŸæ›¿æ¢ï¼AIç°åœ¨åº”è¯¥èƒ½çœ‹åˆ°æ–°çš„è§†é¢‘æµ');
      
      // ğŸ¯ å¢å¼ºçš„æ›¿æ¢åéªŒè¯
      setTimeout(() => {
        const currentTrack = sender.track;
        const stats = {
          currentTrack: currentTrack?.label || 'none',
          enabled: currentTrack?.enabled,
          readyState: currentTrack?.readyState,
          muted: currentTrack?.muted,
          settings: currentTrack?.getSettings(),
          // æ£€æŸ¥æ˜¯å¦çœŸçš„æ˜¯æˆ‘ä»¬æƒ³è¦çš„è½¨é“
          isExpectedTrack: currentTrack?.label === newTrack.label
        };
        
        console.log('ğŸ” æ›¿æ¢åéªŒè¯:', stats);
        
        // ğŸ¯ å…³é”®æ£€æŸ¥ï¼šç¡®ä¿æ›¿æ¢ç¡®å®ç”Ÿæ•ˆ
        if (!stats.isExpectedTrack) {
          console.error('âŒ è½¨é“æ›¿æ¢å¯èƒ½å¤±è´¥ï¼šå½“å‰è½¨é“ä¸æœŸæœ›è½¨é“ä¸ç¬¦');
        }
        
        if (!stats.enabled) {
          console.warn('âš ï¸ æ›¿æ¢åè½¨é“æœªå¯ç”¨');
        }
        
        if (stats.readyState !== 'live') {
          console.warn('âš ï¸ æ›¿æ¢åè½¨é“çŠ¶æ€å¼‚å¸¸:', stats.readyState);
        }
      }, 500);
      
    } else {
      console.error('âŒ æ— æ³•æ›¿æ¢è§†é¢‘è½¨é“:', {
        senderExists: !!sender,
        senderTrack: sender?.track?.label || 'none',
        videoTracksCount: newStream.getVideoTracks().length,
        allTracks: newStream.getTracks().map(t => ({ 
          kind: t.kind, 
          label: t.label, 
          enabled: t.enabled,
          readyState: t.readyState 
        }))
      });
      throw new Error('æ— æ³•æ‰¾åˆ°è§†é¢‘å‘é€å™¨æˆ–æ–°æµä¸­æ²¡æœ‰è§†é¢‘è½¨é“');
    }
  }
  
  return {
    // çŠ¶æ€
    state,
    
    // è®¡ç®—å±æ€§
    isConnected,
    canStartScreenShare,
    isMobile,
    qualityText,
    connectionStatusText,
    
    // æ–¹æ³•
    initializeScreenShare,
    setPeerConnection,
    startScreenShare,
    stopScreenShare,
    toggleScreenShare,
    updateScreenShareOptions,
    toggleSettingsPanel,
    toggleStatsPanel,
    clearError,
    replaceVideoTrack
  };
});
