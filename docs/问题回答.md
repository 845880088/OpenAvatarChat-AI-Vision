# OpenAvatarChat 配置问答

## LAM vs LiteAvatar 区别

### 核心区别
- **LAM**: 3D数字人，客户端渲染，超写实效果，服务端配置要求极低
- **LiteAvatar**: 2D数字人，服务端渲染，高质量效果，配置要求中等  
- **MuseTalk**: 2D数字人，支持自定义底版视频，仅GPU推理

### 配置要求对比
| 数字人类型 | 服务端算力需求 | 并发能力 | 视觉效果 |
|----------|-------------|---------|---------|
| LAM | 极低(仅VAD+ASR) | 5路 | 超写实3D |
| LiteAvatar | 中等(3GB显存/路) | 2-3路 | 高质量2D |
| MuseTalk | 中等(4GB显存/路) | 2路 | 可自定义形象 |

---

## 7个配置文件API设置

### 1. **chat_with_lam.yaml** 
```yaml
需要配置的API:
✅ LLM API: 阿里云百炼
   - DASHSCOPE_API_KEY=sk-xxxx
✅ TTS API: 百炼CosyVoice  
   - 同上API Key
```

### 2. **chat_with_qwen_omni.yaml**
```yaml
需要配置的API:
✅ Qwen-Omni API: 阿里云百炼
   - DASHSCOPE_API_KEY=sk-xxxx
```

### 3. **chat_with_minicpm.yaml**
```yaml
需要配置的API:
❌ 无需API - 完全本地推理
```

### 4. **chat_with_openai_compatible.yaml**
```yaml
需要配置的API:
✅ LLM API: 任意OpenAI兼容API
   - DASHSCOPE_API_KEY=sk-xxxx (百炼)
   - 或其他API Key
```

### 5. **chat_with_openai_compatible_edge_tts.yaml**
```yaml
需要配置的API:
✅ LLM API: 任意OpenAI兼容API
   - DASHSCOPE_API_KEY=sk-xxxx (百炼)
   - 或其他API Key
❌ TTS无需API - 使用免费Edge TTS
```

### 6. **chat_with_openai_compatible_bailian_cosyvoice.yaml**
```yaml
需要配置的API:
✅ LLM API: 任意OpenAI兼容API
✅ TTS API: 百炼CosyVoice
   - DASHSCOPE_API_KEY=sk-xxxx (两个都用百炼)
```

### 7. **chat_with_openai_compatible_bailian_cosyvoice_musetalk.yaml**
```yaml
需要配置的API:
✅ LLM API: 任意OpenAI兼容API  
✅ TTS API: 百炼CosyVoice
   - DASHSCOPE_API_KEY=sk-xxxx (两个都用百炼)
```

---

## API配置方法

### 环境变量配置 (推荐)
```bash
# 创建.env文件
echo "DASHSCOPE_API_KEY=sk-your-api-key-here" > .env

# 或直接设置环境变量
export DASHSCOPE_API_KEY=sk-your-api-key-here
```

### 配置文件直接设置
```yaml
LLMOpenAICompatible:
  api_key: "sk-your-api-key-here"  # 不推荐硬编码

CosyVoice:
  api_key: "sk-your-api-key-here"  # 不推荐硬编码
```

---

## chat_with_lam.yaml 详细配置说明

### 🎯 配置概述
**chat_with_lam.yaml** 是LAM 3D数字人的最优配置，采用客户端渲染技术，服务端算力需求极低，支持高并发。

### 📋 Handler组件详解

#### 1. **LamClient - 3D渲染客户端**
```yaml
LamClient:
  module: client/h5_rendering_client/client_handler_lam
  asset_path: "lam_samples/barbara.zip"  # 3D数字人资产
  connection_ttl: 900  # 会话超时15分钟
```
- **作用**: 管理H5客户端，加载Gaussian Splatting 3D资产
- **特点**: 客户端渲染，服务端无渲染压力
- **并发**: 支持最多5路同时连接

#### 2. **SenseVoice - 语音识别(ASR)**
```yaml
SenseVoice:
  module: asr/sensevoice/asr_handler_sensevoice
  model_name: "iic/SenseVoiceSmall"
```
- **作用**: 将用户语音转换为文字
- **模型**: 阿里SenseVoice，支持中英文
- **特点**: 本地推理，无需API

#### 3. **LLMOpenAICompatible - 大语言模型**
```yaml
LLMOpenAICompatible:
  model_name: "qwen-plus"
  api_url: "https://dashscope.aliyuncs.com/compatible-mode/v1"
  # api_key: "" # 从环境变量DASHSCOPE_API_KEY读取
```
- **作用**: 理解用户问题，生成回答
- **API需求**: ✅ **需要DASHSCOPE_API_KEY**
- **支持模型**: Qwen-Plus, Qwen-Max等
- **可替换**: 支持Ollama、Gemini等其他API

#### 4. **CosyVoice - 语音合成(TTS)**
```yaml
CosyVoice:
  module: tts/bailian_tts/tts_handler_cosyvoice_bailian
  voice: "longxiaocheng"
  model_name: "cosyvoice-v1"
  # api_key: "" # 从环境变量DASHSCOPE_API_KEY读取
```
- **作用**: 将文字回答转换为语音
- **API需求**: ✅ **需要DASHSCOPE_API_KEY**
- **音色**: 支持多种预设音色
- **特点**: 云端合成，音质优秀

#### 5. **LAM_Driver - 3D表情驱动**
```yaml
LAM_Driver:
  module: avatar/lam/avatar_handler_lam_audio2expression
```
- **作用**: 根据语音生成3D面部表情数据
- **特点**: 本地推理，轻量级
- **输出**: 表情参数发送给客户端渲染

#### 6. **SileroVad - 语音活动检测**
```yaml
SileroVad:
  speaking_threshold: 0.5  # 语音检测阈值
  end_delay: 5000         # 结束延迟5秒
```
- **作用**: 检测用户何时开始/结束说话
- **特点**: 本地推理，低延迟

### 🔑 必需API配置

#### 阿里云百炼API Key (必需)
```bash
# 方法1: 环境变量设置
export DASHSCOPE_API_KEY=sk-your-api-key-here

# 方法2: .env文件
echo "DASHSCOPE_API_KEY=sk-your-api-key-here" > .env
```

**用途**:
- **LLM API**: Qwen-Plus模型调用
- **TTS API**: CosyVoice语音合成

**获取方式**:
1. 访问 [阿里云百炼](https://bailian.console.aliyun.com/)
2. 注册账号，实名认证
3. 开通模型服务，获取API Key

### 🔄 可选API替换

#### LLM API替换
```yaml
# Ollama本地部署
api_url: 'http://127.0.0.1:11434/v1'

# Google Gemini
api_url: 'https://generativelanguage.googleapis.com/v1beta/openai/'
# 需要设置 GOOGLE_API_KEY

# DeepSeek
api_url: 'https://api.deepseek.com'
# 需要设置 DEEPSEEK_API_KEY
```

### ⚡ 性能特点

#### 算力分配
```yaml
服务端 (极低算力):
├── SileroVad: CPU推理，极轻量
├── SenseVoice: CPU/GPU推理，约1GB显存  
├── LAM_Driver: CPU推理，极轻量
├── LLM: 云端API，无本地算力
└── TTS: 云端API，无本地算力

客户端 (承担渲染):
└── 3D Avatar渲染: WebGL，客户端GPU
```

#### 并发能力
- **最大并发**: 5路同时连接
- **性能衰减**: 几乎无衰减（客户端渲染）
- **瓶颈**: 网络带宽（传输3D资产）

### 📊 成本分析

#### API调用成本
```yaml
LLM成本 (Qwen-Plus):
- 输入: ¥0.0014/千token
- 输出: ¥0.002/千token  
- 估算: 每次对话约¥0.01-0.05

TTS成本 (CosyVoice):
- 约¥0.1/千字符
- 估算: 每次回答约¥0.02-0.1

总成本: 每次对话约¥0.03-0.15
```

#### 硬件成本
```yaml
服务端硬件需求 (极低):
- CPU: 4核即可
- 内存: 8GB
- GPU: GTX1060或无GPU（CPU推理）
- 显存: <2GB

客户端要求:
- 支持WebGL的现代浏览器
- 移动端: iOS Safari, Android Chrome
```

### 🎯 适用场景

#### 最佳应用场景
✅ **展会数字人**: 超写实3D效果震撼  
✅ **高端客户服务**: VIP级别体验  
✅ **一机多路部署**: 5路并发，成本效益高  
✅ **云端部署**: 服务器算力需求极低  
✅ **品牌展示**: 3D效果提升品牌形象  

#### 注意事项
⚠️ **网络要求**: 首次需要下载3D资产（约几MB）  
⚠️ **设备兼容**: 需要WebGL支持，部分老设备不兼容  
⚠️ **API依赖**: 依赖阿里云服务稳定性  

### 🚀 部署建议

#### 推荐部署流程
```bash
1. 准备API Key: 获取DASHSCOPE_API_KEY
2. 下载依赖: bash scripts/download_liteavatar_weights.sh
3. 配置SSL: bash scripts/create_ssl_certs.sh (非localhost访问)
4. 启动服务: uv run src/demo.py --config config/chat_with_lam.yaml
5. 访问测试: https://your-domain:8282
```

#### 优化建议
```yaml
# 网络优化
启用CDN: 加速3D资产加载
开启gzip: 压缩传输数据

# 并发优化  
concurrent_limit: 5  # 充分利用并发能力
connection_ttl: 1800  # 延长会话时间至30分钟

# 音色定制
voice: "longxiaocheng"  # 可选其他音色
```

---

## 配置文件体系分析

### 📁 两套配置体系

#### 1️⃣ **chat_with_*.yaml 系列（官方标准配置）**
- **数量**: 7个配置文件
- **特点**: 详细注释、生产级配置、多种API选择
- **运行方式**: `uv run src/demo.py --config config/xxx.yaml`
- **网络模式**: `host: "0.0.0.0"` （允许外网访问）

#### 2️⃣ **glut*.yaml 系列（简化版配置）**
- **数量**: 3个配置文件（glut.yaml, glut2.yaml, glut3.yaml）
- **特点**: 简化配置、一键启动、预设API
- **运行方式**: `python src/glut.py --config config/xxx.yaml`
- **网络模式**: `host: "127.0.0.1"` （仅本地访问）

---

## 🔗 运行脚本与配置文件对应关系

### 配置文件映射表
| 运行脚本 | 对应配置 | 数字人类型 | LLM模型 | TTS方案 |
|---------|---------|----------|---------|---------|
| `01运行程序-lam.bat` | `config/glut.yaml` | **LAM** (3D) | Qwen3-Max | Edge TTS |
| `02运行程序-liteavatar.bat` | `config/glut2.yaml` | **LiteAvatar** (2D) | Qwen3-Max | Edge TTS |
| `03运行程序-musetalk.bat` | `config/glut3.yaml` | **MuseTalk** (2D) | Qwen3-Max | Edge TTS |

### 运行脚本特点分析

#### 💻 **运行环境设置**
```batch
# 所有脚本都设置了相同的Python环境
set "PYTHON=%CD%\.glut\python.exe"           # 使用.glut目录下的Python
set "HF_ENDPOINT=https://hf-mirror.com"      # 国内HuggingFace镜像
set "HF_HOME=%CD%\models"                    # 模型缓存目录
set "TORCH_HOME=%CD%\models"                 # PyTorch模型缓存
set "MODELSCOPE_CACHE=%CD%"                  # ModelScope缓存
```

#### 🎯 **启动命令对比**
```batch
# 运行脚本使用 glut.py
%PYTHON% src/glut.py --config config/glut.yaml
%PYTHON% src/glut.py --config config/glut2.yaml  
%PYTHON% src/glut.py --config config/glut3.yaml

# 官方配置使用 demo.py
uv run src/demo.py --config config/chat_with_lam.yaml
```

---

## 🔍 配置差异详细对比

### LLM配置差异

#### **glut系列 - 统一使用阿里云Qwen3-Max模型**
```yaml
LLM_Bailian:  # 命名为Bailian，实际使用阿里云DashScope API
  model_name: "qwen3-max"                    # 阿里云通义千问3-Max模型
  api_url: "https://dashscope.aliyuncs.com/compatible-mode/v1"  # 阿里云DashScope API
  # api_key: "your-api-key-here"  # 请替换为你的API Key，或留空从环境变量读取
  enable_video_input: false                  # 视频输入
```

#### **chat系列 - 主要使用阿里百炼**
```yaml
LLMOpenAICompatible:
  model_name: "qwen-plus"                    # 阿里Qwen系列模型
  api_url: "https://dashscope.aliyuncs.com/compatible-mode/v1"  # 百炼API
  # api_key: ""                             # 从环境变量读取，更安全
```

### TTS配置差异

#### **glut系列 - 统一使用免费Edge TTS**
```yaml
Edge_TTS:
  voice: "zh-CN-YunyangNeural"    # glut.yaml 男声
  voice: "zh-CN-XiaoxiaoNeural"   # glut2.yaml/glut3.yaml 女声
```

#### **chat系列 - 多种TTS方案**
```yaml
# 方案1: 百炼CosyVoice (收费，高质量)
CosyVoice:
  module: tts/bailian_tts/tts_handler_cosyvoice_bailian

# 方案2: 本地CosyVoice (免费，需GPU)  
CosyVoice:
  module: tts/cosyvoice/tts_handler_cosyvoice

# 方案3: Edge TTS (免费，云端)
Edge_TTS:
  module: tts/edgetts/tts_handler_edgetts
```

### Avatar配置差异

#### **glut.yaml - LAM 3D数字人**
```yaml
LamClient:
  module: client/h5_rendering_client/client_handler_lam
  asset_path: "lam_samples/barbara.zip"      # 3D资产
  concurrent_limit: 5                        # 支持5路并发
```

#### **glut2.yaml - LiteAvatar 2D数字人**  
```yaml
LiteAvatar:
  module: avatar/liteavatar/avatar_handler_liteavatar
  avatar_name: 20250408/sample_data
  use_gpu: true
```

#### **glut3.yaml - MuseTalk 2D数字人**
```yaml
AvatarMusetalk:
  module: avatar/musetalk/avatar_handler_musetalk
  fps: 16                                    # 较低帧率
  batch_size: 16                            # 较大批处理
```

---

## 📋 使用建议

### 🚀 **快速体验（推荐glut系列）**
- **优势**: 一键启动、无需配置API Key、Edge TTS免费
- **适合**: 初次体验、演示展示、个人测试
- **限制**: 仅本地访问、API Key硬编码、配置选项少

```bash
# Windows一键启动
双击 01运行程序-lam.bat      # LAM 3D数字人
双击 02运行程序-liteavatar.bat # LiteAvatar 2D数字人  
双击 03运行程序-musetalk.bat   # MuseTalk 2D数字人
```

### 🏭 **生产部署（推荐chat系列）**
- **优势**: 详细配置、环境变量管理、外网访问、多API选择
- **适合**: 正式部署、企业应用、定制需求
- **要求**: 需要配置API Key、理解配置参数

```bash
# 生产环境启动
uv run src/demo.py --config config/chat_with_lam.yaml
uv run src/demo.py --config config/chat_with_openai_compatible_bailian_cosyvoice.yaml
```

---

## 快速选择指南

| 你的需求 | 推荐配置 | 需要API |
|---------|---------|---------|
| **快速体验LAM 3D效果** | `01运行程序-lam.bat` | 无（预设API） |
| **快速体验LiteAvatar** | `02运行程序-liteavatar.bat` | 无（预设API） |  
| **快速体验MuseTalk** | `03运行程序-musetalk.bat` | 无（预设API） |
| 追求最佳效果+多路并发 | `chat_with_lam.yaml` | 百炼API |
| 完全本地化+隐私保护 | `chat_with_minicpm.yaml` | 无 |
| 快速上线+无API成本 | `chat_with_openai_compatible_edge_tts.yaml` | LLM API |
| 生产环境推荐 | `chat_with_openai_compatible_bailian_cosyvoice.yaml` | 百炼API |
| 自定义数字人形象 | `chat_with_openai_compatible_bailian_cosyvoice_musetalk.yaml` | 百炼API |
