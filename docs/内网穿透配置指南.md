# OpenAvatarChat å¤–ç½‘éƒ¨ç½²å®Œæ•´æŒ‡å—

## ğŸ“– æ¦‚è¿°

æœ¬æŒ‡å—åŸºäº**çœŸå®æˆåŠŸéƒ¨ç½²ç»éªŒ**ï¼Œè¯¦ç»†è¯´æ˜å¦‚ä½•å°†OpenAvatarChaté¡¹ç›®é€šè¿‡**å†…ç½‘ç©¿é€ + äº‘æœåŠ¡å™¨TURNä¸­ç»§**çš„æ–¹å¼æš´éœ²åˆ°å…¬ç½‘ï¼Œå®ç°è·¨ç½‘ç»œçš„æ•°å­—äººå¯¹è¯æœåŠ¡ã€‚

> **ğŸš¨ æ ¸å¿ƒè­¦å‘Š**ï¼š99%çš„WebRTCè¿æ¥å¤±è´¥éƒ½æ˜¯**é˜²ç«å¢™/å®‰å…¨ç»„é…ç½®é”™è¯¯**ï¼è¿™æ˜¯ç¬¬ä¸€è¦åŠ¡ï¼
> 
> **âš ï¸ é‡è¦æé†’**ï¼šå•çº¯çš„å†…ç½‘ç©¿é€**æ— æ³•**æ”¯æŒWebRTCåŠŸèƒ½ï¼ˆæ•°å­—äººæ˜¾ç¤ºå’Œè¯­éŸ³å¯¹è¯ï¼‰ï¼Œå¿…é¡»é…åˆäº‘æœåŠ¡å™¨éƒ¨ç½²TURNæœåŠ¡å™¨æ‰èƒ½å®Œæ•´å·¥ä½œï¼

## ğŸ¯ éƒ¨ç½²ç›®æ ‡

- **æœ¬åœ°æœåŠ¡**ï¼š`127.0.0.1:8282` (OpenAvatarChaté¡¹ç›®)
- **å†…ç½‘ç©¿é€**ï¼š`https://your-domain.com:port` (Webç•Œé¢è®¿é—®)
- **äº‘æœåŠ¡å™¨TURN**ï¼šWebRTCåª’ä½“æµä¸­ç»§æœåŠ¡
- **æ”¯æŒåŠŸèƒ½**ï¼šâœ… Webç•Œé¢ + âœ… æ•°å­—äººæ˜¾ç¤º + âœ… è¯­éŸ³å¯¹è¯

---

## ğŸ” æŠ€æœ¯åŸç†è¯´æ˜

### ä¸ºä»€ä¹ˆéœ€è¦äº‘æœåŠ¡å™¨ï¼Ÿ

**å†…ç½‘ç©¿é€å·¥å…·çš„æ ¹æœ¬é™åˆ¶ï¼š**

```
âœ… HTTP/HTTPSä¿¡ä»¤ â†’ å†…ç½‘ç©¿é€ â†’ æœ¬åœ°æœåŠ¡å™¨ (æ­£å¸¸å·¥ä½œ)
âŒ WebRTCåª’ä½“æµ â†’ å†…ç½‘ç©¿é€ â†’ ??? (æ— æ³•ä¼ è¾“UDP)
```

**WebRTCå·¥ä½œåŸç†ï¼š**
1. **ä¿¡ä»¤é˜¶æ®µ**ï¼šé€šè¿‡HTTP/HTTPSäº¤æ¢è¿æ¥ä¿¡æ¯ (å†…ç½‘ç©¿é€å¯ä»¥å¤„ç†)
2. **åª’ä½“ä¼ è¾“**ï¼šé€šè¿‡UDPç›´æ¥ä¼ è¾“éŸ³è§†é¢‘æ•°æ® (å†…ç½‘ç©¿é€æ— æ³•å¤„ç†)

**å› æ­¤éœ€è¦ï¼š**
- **å†…ç½‘ç©¿é€**ï¼šå¤„ç†Webç•Œé¢å’ŒAPIè¯·æ±‚
- **äº‘æœåŠ¡å™¨TURN**ï¼šä¸­ç»§WebRTCåª’ä½“æµ

---

## ğŸš€ éƒ¨ç½²æ¶æ„å›¾

```
æ‰‹æœº/ç”µè„‘å®¢æˆ·ç«¯
    â†“ (HTTPSè®¿é—®ç•Œé¢)
å†…ç½‘ç©¿é€æœåŠ¡ â†’ æœ¬åœ°OpenAvatarChat
    â†“ (WebRTCåª’ä½“æµ)
äº‘æœåŠ¡å™¨TURNä¸­ç»§ â†’ å®¢æˆ·ç«¯
```

---

## ğŸ“‹ éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæœ¬åœ°é¡¹ç›®å‡†å¤‡

#### 1.1 SSLè¯ä¹¦é…ç½®

```bash
# è¿›å…¥é¡¹ç›®æ ¹ç›®å½•
cd E:\OpenAvatarChat-250916

# ç”ŸæˆSSLè¯ä¹¦ï¼ˆæ›¿æ¢your-domain.comä¸ºå®é™…åŸŸåï¼‰
"C:\Program Files\Git\usr\bin\openssl.exe" req -x509 -newkey rsa:2048 \
  -keyout ssl_certs\localhost.key \
  -out ssl_certs\localhost.crt \
  -days 365 -nodes \
  -subj "/C=CN/ST=Beijing/L=Beijing/O=OpenAvatarChat/OU=Development/CN=your-domain.com" \
  -addext "subjectAltName=DNS:your-domain.com,DNS:localhost,IP:127.0.0.1"
```

#### 1.2 æœåŠ¡é…ç½®ä¿®æ”¹

ä¿®æ”¹ `config/glut-VL.yaml` (æˆ–ä½ ä½¿ç”¨çš„é…ç½®æ–‡ä»¶)ï¼š

```yaml
default:
  service:
    host: "0.0.0.0"    # âš ï¸ å¿…é¡»æ”¹ä¸º0.0.0.0å…è®¸å¤–ç½‘è®¿é—®
    port: 8282
    cert_file: "ssl_certs/localhost.crt"
    cert_key: "ssl_certs/localhost.key"
  
  chat_engine:
    handler_configs:
      RtcClient:  # æˆ–è€…LamClientï¼Œæ ¹æ®ä½ çš„é…ç½®
        turn_config:
          turn_provider: "turn_server"
          urls: 
            - "stun:stun.l.google.com:19302"
            - "stun:stun1.l.google.com:19302"
            - "turn:YOUR-CLOUD-SERVER-IP:3478"  # ç¬¬ä¸‰æ­¥é…ç½®çš„äº‘æœåŠ¡å™¨
          username: "username"
          credential: "password"
```

> **æ³¨æ„**ï¼šTURNé…ç½®åœ¨ç¬¬ä¸‰æ­¥äº‘æœåŠ¡å™¨é…ç½®å®Œæˆåå†ä¿®æ”¹

---

### ç¬¬äºŒæ­¥ï¼šå†…ç½‘ç©¿é€é…ç½®

#### 2.1 é€‰æ‹©å†…ç½‘ç©¿é€å·¥å…·

**æ¨èå·¥å…·ï¼š**
- **frp** (å¼€æºå…è´¹)
- **ngrok** (å•†ä¸šæœåŠ¡)
- **ZeroNews** (æœ¬æŒ‡å—ä½¿ç”¨)
- **èŠ±ç”Ÿå£³** (å›½å†…æœåŠ¡)

#### 2.2 é…ç½®ç¤ºä¾‹

**TCPåè®®æ˜ å°„ï¼ˆé‡è¦ï¼‰ï¼š**
```
åè®®ç±»å‹ï¼šTCP
å†…ç½‘åœ°å€ï¼š127.0.0.1:8282
å…¬ç½‘åœ°å€ï¼šyour-domain.com:ç«¯å£å·
```

**âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹ï¼š**
- å¿…é¡»ä½¿ç”¨**TCPåè®®**ï¼Œä¸è¦é€‰æ‹©HTTP/HTTPS
- å†…ç½‘åœ°å€å¿…é¡»æ˜¯ `127.0.0.1:8282`
- ç¡®ä¿æ˜ å°„åˆ°çš„å…¬ç½‘ç«¯å£å¯è®¿é—®

#### 2.3 frpé…ç½®ç¤ºä¾‹

```ini
# frpc.ini
[common]
server_addr = your-frp-server.com
server_port = 7000
token = your-token

[openavatarchat]
type = tcp
local_ip = 127.0.0.1
local_port = 8282
remote_port = 8282
```

---

### ç¬¬ä¸‰æ­¥ï¼šäº‘æœåŠ¡å™¨TURNéƒ¨ç½² (â­ å…³é”®æ­¥éª¤)

#### 3.1 äº‘æœåŠ¡å™¨é€‰æ‹©

**æ¨èé…ç½®ï¼š**
- **CPU**: 1æ ¸å³å¯
- **å†…å­˜**: 1GBå³å¯  
- **å¸¦å®½**: 1Mbpsèµ·æ­¥ï¼Œæ¨è3Mbps+
- **ç³»ç»Ÿ**: CentOS 7/8 æˆ– Ubuntu 18.04+
- **é‡è¦**: å¿…é¡»æœ‰**å…¬ç½‘IP**

**æ¨èæœåŠ¡å•†ï¼š**
- é˜¿é‡Œäº‘ECS (æœ‰å…è´¹è¯•ç”¨)
- è…¾è®¯äº‘CVM
- åä¸ºäº‘ECS
- å¢ƒå¤–ï¼šAWS EC2ã€Google Cloud

#### 3.2 é˜²ç«å¢™é…ç½® (ğŸš¨ ç¬¬ä¸€è¦åŠ¡ï¼)

> **ğŸ’€ é‡è¦è­¦å‘Š**ï¼šè¿™æ˜¯99%ç”¨æˆ·å¤±è´¥çš„åœ°æ–¹ï¼å¿…é¡»ä¸¥æ ¼æŒ‰æ­¥éª¤é…ç½®ï¼

**å¿…éœ€å¼€æ”¾çš„ç«¯å£ï¼š**
```
TCP 3478          (TURNæœåŠ¡ä¸»ç«¯å£)
UDP 3478          (TURNæœåŠ¡ä¸»ç«¯å£)  
UDP 49152-65535   (WebRTCåª’ä½“ä¼ è¾“ç«¯å£èŒƒå›´)
```

##### é˜¿é‡Œäº‘ECSå®‰å…¨ç»„é…ç½®ï¼ˆè¯¦ç»†æ­¥éª¤ï¼‰

**æ­¥éª¤1ï¼šè¿›å…¥å®‰å…¨ç»„é…ç½®**
1. ç™»å½•é˜¿é‡Œäº‘æ§åˆ¶å°
2. è¿›å…¥ **äº‘æœåŠ¡å™¨ECS** â†’ **å®ä¾‹**
3. æ‰¾åˆ°æ‚¨çš„å®ä¾‹ï¼Œç‚¹å‡»å®ä¾‹ID
4. åœ¨å®ä¾‹è¯¦æƒ…é¡µé¢ï¼Œç‚¹å‡» **å®‰å…¨ç»„** æ ‡ç­¾é¡µ
5. ç‚¹å‡»å®‰å…¨ç»„IDè¿›å…¥å®‰å…¨ç»„è¯¦æƒ…
6. ç‚¹å‡» **å…¥æ–¹å‘** æ ‡ç­¾é¡µ
7. ç‚¹å‡» **æ·»åŠ å®‰å…¨ç»„è§„åˆ™**

**æ­¥éª¤2ï¼šæ·»åŠ TURN TCPç«¯å£è§„åˆ™**
```
ç«¯å£èŒƒå›´ç±»å‹: è‡ªå®šä¹‰
åè®®ç±»å‹: TCP  
ç«¯å£èŒƒå›´: 3478
æˆæƒå¯¹è±¡: 0.0.0.0/0
æè¿°: TURN TCPç«¯å£
```
ç‚¹å‡» **ç¡®å®š** ä¿å­˜

**æ­¥éª¤3ï¼šæ·»åŠ TURN UDPç«¯å£è§„åˆ™**  
```
ç«¯å£èŒƒå›´ç±»å‹: è‡ªå®šä¹‰
åè®®ç±»å‹: UDP
ç«¯å£èŒƒå›´: 3478  
æˆæƒå¯¹è±¡: 0.0.0.0/0
æè¿°: TURN UDPç«¯å£
```
ç‚¹å‡» **ç¡®å®š** ä¿å­˜

**æ­¥éª¤4ï¼šæ·»åŠ WebRTCåª’ä½“ç«¯å£è§„åˆ™**
```
ç«¯å£èŒƒå›´ç±»å‹: è‡ªå®šä¹‰  
åè®®ç±»å‹: UDP
ç«¯å£èŒƒå›´: 49152/65535
æˆæƒå¯¹è±¡: 0.0.0.0/0
æè¿°: WebRTCåª’ä½“ç«¯å£
```

> **âš ï¸ ç«¯å£èŒƒå›´æ³¨æ„äº‹é¡¹**ï¼š
> - å¦‚æœ `49152/65535` æŠ¥é”™"ç«¯å£èŒƒå›´ä¸åˆæ³•"
> - æ”¹ä¸ºï¼š`50000/60000` 
> - ç«¯å£æ ¼å¼ï¼šåªå¡«æ•°å­—ï¼Œä¸è¦å¡« `3478/3478`ï¼Œåªå¡« `3478`

**æ­¥éª¤5ï¼šéªŒè¯å®‰å…¨ç»„è§„åˆ™**
é…ç½®å®Œæˆåï¼Œåº”è¯¥çœ‹åˆ°ç±»ä¼¼çš„è§„åˆ™åˆ—è¡¨ï¼š
```
åè®®ç±»å‹  ç«¯å£èŒƒå›´      æˆæƒå¯¹è±¡     æè¿°
TCP      3478         0.0.0.0/0    TURN TCPç«¯å£  
UDP      3478         0.0.0.0/0    TURN UDPç«¯å£
UDP      50000/60000  0.0.0.0/0    WebRTCåª’ä½“ç«¯å£
```

##### å…¶ä»–äº‘æœåŠ¡å•†é˜²ç«å¢™é…ç½®

**è…¾è®¯äº‘å®‰å…¨ç»„ï¼š**
- è¿›å…¥ äº‘æœåŠ¡å™¨ â†’ å®‰å…¨ç»„ â†’ æ·»åŠ è§„åˆ™
- é…ç½®ç›¸åŒçš„ç«¯å£è§„åˆ™

**åä¸ºäº‘å®‰å…¨ç»„ï¼š**  
- è¿›å…¥ å¼¹æ€§äº‘æœåŠ¡å™¨ â†’ å®‰å…¨ç»„ â†’ ç®¡ç†è§„åˆ™
- é…ç½®ç›¸åŒçš„ç«¯å£è§„åˆ™

**AWS EC2å®‰å…¨ç»„ï¼š**
- è¿›å…¥ EC2 â†’ Security Groups â†’ Inbound Rules
- é…ç½®ç›¸åŒçš„ç«¯å£è§„åˆ™

#### 3.3 å®‰è£…å’Œé…ç½®TURNæœåŠ¡å™¨

**æ–¹æ³•ä¸€ï¼šä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæ¨è â­ï¼‰**

**ä¸Šä¼ å¹¶è¿è¡Œä¿®å¤è„šæœ¬ï¼š**
```bash
# SSHè¿æ¥åˆ°äº‘æœåŠ¡å™¨
ssh admin@YOUR-SERVER-IP

# æ‰‹åŠ¨åˆ›å»ºè‡ªåŠ¨ä¿®å¤è„šæœ¬
nano fix_coturn.sh
```

**fix_coturn.sh å†…å®¹ï¼š**
```bash
#!/bin/bash

echo "ğŸ”§ OpenAvatarChat coturnè‡ªåŠ¨ä¿®å¤è„šæœ¬"
echo "=================================="

# æ£€æŸ¥æ˜¯å¦ä¸ºrootç”¨æˆ·
if [ "$EUID" -ne 0 ]; then
    echo "âŒ è¯·ä½¿ç”¨sudoè¿è¡Œæ­¤è„šæœ¬: sudo bash fix_coturn.sh"
    exit 1
fi

echo "ğŸ” Step 1: è¯Šæ–­å½“å‰coturnçŠ¶æ€..."

# åœæ­¢coturnæœåŠ¡
echo "â¹ï¸  åœæ­¢coturnæœåŠ¡..."
systemctl stop coturn

# æŸ¥çœ‹å½“å‰ç›‘å¬ç«¯å£
echo "ğŸ“Š æ£€æŸ¥3478ç«¯å£å ç”¨æƒ…å†µ:"
netstat -tulpn | grep 3478 || echo "âœ… 3478ç«¯å£å·²é‡Šæ”¾"

echo ""
echo "ğŸ”§ Step 2: åˆ›å»ºæ­£ç¡®çš„é…ç½®æ–‡ä»¶..."

# è·å–æœåŠ¡å™¨IPä¿¡æ¯
PRIVATE_IP=$(ip route get 8.8.8.8 | awk '{print $7; exit}')
PUBLIC_IP=$(curl -s ifconfig.me || curl -s ipinfo.io/ip)

echo "ğŸŒ æ£€æµ‹åˆ°å†…ç½‘IP: $PRIVATE_IP"
echo "ğŸŒ æ£€æµ‹åˆ°å…¬ç½‘IP: $PUBLIC_IP"

# åˆ›å»ºæ­£ç¡®çš„é…ç½®æ–‡ä»¶
CONFIG_FILE="/etc/turnserver.conf"
echo "ğŸ“ åˆ›å»ºé…ç½®æ–‡ä»¶: $CONFIG_FILE"

cat > "$CONFIG_FILE" << EOF
listening-port=3478
listening-ip=0.0.0.0
relay-ip=$PRIVATE_IP
external-ip=$PUBLIC_IP
min-port=49152
max-port=65535
verbose
fingerprint
lt-cred-mech
user=username:password
realm=turn.${PUBLIC_IP//./-}.turnserver
EOF

echo "âœ… é…ç½®æ–‡ä»¶å·²åˆ›å»º"
echo "ğŸ“‹ é…ç½®å†…å®¹:"
cat "$CONFIG_FILE"

echo ""
echo "ğŸ”§ Step 3: å¯åŠ¨coturn..."

# æ‰‹åŠ¨å¯åŠ¨coturnå¹¶æŒ‡å®šé…ç½®æ–‡ä»¶
echo "ğŸš€ å¯åŠ¨coturnæœåŠ¡..."
systemctl start coturn

# ç­‰å¾…2ç§’è®©æœåŠ¡å¯åŠ¨
sleep 2

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "ğŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€:"
systemctl status coturn --no-pager -l

echo ""
echo "ğŸ“Š æ£€æŸ¥ç«¯å£ç›‘å¬çŠ¶æ€:"
netstat -tulpn | grep 3478

echo ""
echo "ğŸ”§ Step 4: éªŒè¯é…ç½®..."

# æ£€æŸ¥æ˜¯å¦æ­£ç¡®ç›‘å¬0.0.0.0
if netstat -tulpn | grep "0.0.0.0:3478" > /dev/null; then
    echo "âœ… æˆåŠŸï¼coturnæ­£åœ¨ç›‘å¬0.0.0.0:3478"
    echo "ğŸ‰ ä¿®å¤å®Œæˆï¼ç°åœ¨æ‰‹æœºåº”è¯¥èƒ½è¿æ¥äº†"
else
    echo "âš ï¸  coturnä»æœªæ­£ç¡®ç›‘å¬ï¼Œå°è¯•æ‰‹åŠ¨å¯åŠ¨..."
    
    # æ‰‹åŠ¨å¯åŠ¨
    echo "ğŸ”§ å°è¯•æ‰‹åŠ¨å¯åŠ¨coturn..."
    systemctl stop coturn
    sleep 1
    
    echo "ğŸ“ æ‰‹åŠ¨å¯åŠ¨å‘½ä»¤:"
    echo "turnserver -c /etc/turnserver.conf -v"
    
    # åå°å¯åŠ¨coturn
    nohup turnserver -c /etc/turnserver.conf -v > /var/log/coturn-manual.log 2>&1 &
    
    sleep 3
    
    echo "ğŸ“Š å†æ¬¡æ£€æŸ¥ç«¯å£:"
    netstat -tulpn | grep 3478
    
    if netstat -tulpn | grep "0.0.0.0:3478" > /dev/null; then
        echo "âœ… æ‰‹åŠ¨å¯åŠ¨æˆåŠŸï¼"
    else
        echo "âŒ æ‰‹åŠ¨å¯åŠ¨ä¹Ÿå¤±è´¥ï¼ŒæŸ¥çœ‹è¯¦ç»†æ—¥å¿—:"
        tail -20 /var/log/coturn-manual.log
    fi
fi

echo ""
echo "ğŸ“‹ ä¿®å¤å®Œæˆï¼è¯·æµ‹è¯•æ‰‹æœºè¿æ¥ï¼š"
echo "URL: https://liao.uunat.com:8282/ui/index.html"
```

**è¿è¡Œè„šæœ¬ï¼š**
```bash
# å…ˆå®‰è£…coturn
sudo yum install -y coturn  # CentOS/RHEL
# æˆ–
sudo apt-get install -y coturn  # Ubuntu/Debian

# è¿è¡Œä¿®å¤è„šæœ¬
chmod +x fix_coturn.sh
sudo bash fix_coturn.sh
```

**æ–¹æ³•äºŒï¼šä½¿ç”¨å…¨é¢éªŒè¯è„šæœ¬**

**åˆ›å»ºéªŒè¯è„šæœ¬ verify_turn_setup.shï¼š**
```bash
nano verify_turn_setup.sh
```

**è„šæœ¬å†…å®¹ï¼š**ï¼ˆè§é™„å½•Aï¼šå®Œæ•´éªŒè¯è„šæœ¬ï¼‰

**è¿è¡ŒéªŒè¯ï¼š**
```bash
chmod +x verify_turn_setup.sh
sudo bash verify_turn_setup.sh
```

**âœ… æˆåŠŸæ ‡å¿—ï¼š**
```bash
ğŸ“Š éªŒè¯ç»“æœæ±‡æ€»
================
âœ… é€šè¿‡é¡¹ç›®: 13
âŒ å¤±è´¥é¡¹ç›®: 0

ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼TURNæœåŠ¡å™¨é…ç½®å®Œç¾ï¼
```

#### 3.4 è‡ªåŠ¨åŒ–ä¿®å¤è„šæœ¬

å¦‚æœé‡åˆ°coturné…ç½®é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨è‡ªåŠ¨ä¿®å¤è„šæœ¬ï¼š

**åˆ›å»º fix_coturn.shï¼š**
```bash
#!/bin/bash
echo "ğŸ”§ OpenAvatarChat coturnè‡ªåŠ¨ä¿®å¤è„šæœ¬"

if [ "$EUID" -ne 0 ]; then
    echo "âŒ è¯·ä½¿ç”¨sudoè¿è¡Œæ­¤è„šæœ¬: sudo bash fix_coturn.sh"
    exit 1
fi

# åœæ­¢æœåŠ¡
systemctl stop coturn

# è·å–IPä¿¡æ¯
PRIVATE_IP=$(ip route get 8.8.8.8 | awk '{print $7; exit}')
PUBLIC_IP=$(curl -s ifconfig.me || curl -s ipinfo.io/ip)

echo "ğŸŒ æ£€æµ‹åˆ°å†…ç½‘IP: $PRIVATE_IP"
echo "ğŸŒ æ£€æµ‹åˆ°å…¬ç½‘IP: $PUBLIC_IP"

# åˆ›å»ºæ­£ç¡®é…ç½®
cat > /etc/turnserver.conf << EOF
listening-port=3478
listening-ip=0.0.0.0
relay-ip=$PRIVATE_IP
external-ip=$PUBLIC_IP
min-port=49152
max-port=65535
verbose
fingerprint
lt-cred-mech
user=username:password
realm=turn.${PUBLIC_IP//./-}.turnserver
EOF

# å¯åŠ¨æœåŠ¡
systemctl start coturn
sleep 2

# éªŒè¯ç»“æœ
if netstat -tulpn | grep "0.0.0.0:3478" > /dev/null; then
    echo "âœ… æˆåŠŸï¼coturnæ­£åœ¨ç›‘å¬0.0.0.0:3478"
else
    echo "âš ï¸ systemdå¯åŠ¨å¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨å¯åŠ¨..."
    systemctl stop coturn
    nohup turnserver -c /etc/turnserver.conf -v > /var/log/coturn-manual.log 2>&1 &
    sleep 3
    
    if netstat -tulpn | grep "0.0.0.0:3478" > /dev/null; then
        echo "âœ… æ‰‹åŠ¨å¯åŠ¨æˆåŠŸï¼"
    else
        echo "âŒ å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—: tail /var/log/coturn-manual.log"
    fi
fi

echo "ğŸ“Š å½“å‰ç«¯å£ç›‘å¬çŠ¶æ€:"
netstat -tulpn | grep 3478
EOF

# ä½¿ç”¨æ–¹æ³•
sudo bash fix_coturn.sh
```

---

### ç¬¬å››æ­¥ï¼šé¡¹ç›®é…ç½®TURNæœåŠ¡å™¨

#### 4.1 æ›´æ–°æœ¬åœ°é…ç½®

ä¿®æ”¹ `config/glut-VL.yaml`ï¼š

```yaml
default:
  chat_engine:
    handler_configs:
      RtcClient:
        turn_config:
          turn_provider: "turn_server"
          urls: 
            - "stun:stun.l.google.com:19302"
            - "stun:stun1.l.google.com:19302"
            - "turn:YOUR-CLOUD-SERVER-IP:3478"  # æ›¿æ¢ä¸ºä½ çš„äº‘æœåŠ¡å™¨å…¬ç½‘IP
          username: "username"
          credential: "password"
```

#### 4.2 å¯åŠ¨é¡¹ç›®

```batch
# Windows
04è¿è¡Œç¨‹åº-lam-VL.bat

# æˆ–ç›´æ¥ä½¿ç”¨Python
uv run src/demo.py --config config/glut-VL.yaml
```

#### 4.3 éªŒè¯é…ç½®

**âœ… æ­£ç¡®çš„å¯åŠ¨æ—¥å¿—ï¼š**
```
INFO | service.rtc_service.rtc_provider - Using STUN configuration
INFO | service.rtc_service.rtc_provider - TURN servers configured: 3 servers
INFO | Service will be started on 0.0.0.0:8282
INFO | SSL enabled.
```

**âŒ é”™è¯¯çš„æ—¥å¿—ï¼š**
```
No valid rtc provider configuration found, STUN/TURN will not be valid
```

---

### ç¬¬äº”æ­¥ï¼šæµ‹è¯•éªŒè¯

#### 5.1 æœ¬åœ°æµ‹è¯•

```
âœ… è®¿é—®: https://127.0.0.1:8282/ui/index.html
âœ… æ•°å­—äººèƒ½æ˜¾ç¤ºï¼Œè¯­éŸ³å¯¹è¯æ­£å¸¸
```

#### 5.2 å…¬ç½‘æµ‹è¯•

```
âœ… è®¿é—®: https://your-domain.com:port/ui/index.html
âœ… ç•Œé¢èƒ½æ­£å¸¸åŠ è½½
âœ… æ•°å­—äººèƒ½æ˜¾ç¤º (å…³é”®æµ‹è¯•)
âœ… è¯­éŸ³å¯¹è¯åŠŸèƒ½æ­£å¸¸ (å…³é”®æµ‹è¯•)
```

#### 5.3 ç§»åŠ¨ç«¯æµ‹è¯•

**ä¸åŒç½‘ç»œç¯å¢ƒæµ‹è¯•ï¼š**
- âœ… WiFiç½‘ç»œ
- âœ… ç§»åŠ¨æ•°æ®ç½‘ç»œ
- âœ… ä¸åŒè¿è¥å•†ç½‘ç»œ

**ä¸åŒè®¾å¤‡æµ‹è¯•ï¼š**
- âœ… Androidæ‰‹æœº + Chromeæµè§ˆå™¨
- âœ… iPhone + Safariæµè§ˆå™¨

---

## ğŸ”§ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šé˜²ç«å¢™/å®‰å…¨ç»„é…ç½®é”™è¯¯ (ğŸš¨ 99%çš„é—®é¢˜æ ¹æº)

**ç—‡çŠ¶ï¼š**
- âœ… Webç•Œé¢æ­£å¸¸åŠ è½½
- âœ… æ–‡å­—å¯¹è¯åŠŸèƒ½æ­£å¸¸  
- âŒ æ•°å­—äººè§†é¢‘çª—å£ç©ºç™½
- âŒ æ— æ³•è¿›è¡Œè¯­éŸ³å¯¹è¯
- âŒ WebRTCè¿æ¥çŠ¶æ€æ˜¾ç¤º `failed`

**æ—¥å¿—ç‰¹å¾ï¼š**
```
INFO: POST /webrtc/offer HTTP/1.1 200 OK (å¤§é‡é‡å¤)
WARNING: Received ICE candidate for unknown connection
icecandidateerror: Failed to establish connection
```

**æ ¹æœ¬åŸå› ï¼š**
**äº‘æœåŠ¡å™¨é˜²ç«å¢™/å®‰å…¨ç»„æ²¡æœ‰æ­£ç¡®å¼€æ”¾TURNç«¯å£ï¼**

**â­ ç¬¬ä¸€ä¼˜å…ˆçº§è§£å†³æ–¹æ¡ˆï¼š**

**æ­¥éª¤1ï¼šéªŒè¯ç«¯å£è¿é€šæ€§**
```powershell
# åœ¨æœ¬åœ°ç”µè„‘PowerShellæµ‹è¯•
Test-NetConnection -ComputerName YOUR-SERVER-IP -Port 3478

# ç»“æœåº”è¯¥æ˜¯ï¼š
TcpTestSucceeded : True  âœ…
# å¦‚æœæ˜¯ Falseï¼Œå°±æ˜¯é˜²ç«å¢™é—®é¢˜ï¼
```

**æ­¥éª¤2ï¼šé‡æ–°é…ç½®äº‘æœåŠ¡å™¨å®‰å…¨ç»„**
- ç™»å½•äº‘æœåŠ¡å™¨æ§åˆ¶å°
- è¿›å…¥å®‰å…¨ç»„é…ç½®
- ç¡®ä¿å¼€æ”¾ï¼šTCP 3478, UDP 3478, UDP 49152-65535
- æˆæƒå¯¹è±¡ï¼š0.0.0.0/0

**æ­¥éª¤3ï¼šéªŒè¯TURNæœåŠ¡å™¨çŠ¶æ€**
```bash
# SSHåˆ°äº‘æœåŠ¡å™¨
ssh admin@YOUR-SERVER-IP

# è¿è¡Œå…¨é¢éªŒè¯
sudo bash verify_turn_setup.sh

# åº”è¯¥çœ‹åˆ°ï¼š
âœ… é€šè¿‡é¡¹ç›®: 13
âŒ å¤±è´¥é¡¹ç›®: 0
```

**æ­¥éª¤4ï¼šå¦‚æœéªŒè¯å¤±è´¥ï¼Œè¿è¡Œä¿®å¤**
```bash
sudo bash fix_coturn.sh
```

### é—®é¢˜2ï¼šcoturnæ— æ³•ç›‘å¬0.0.0.0

**ç—‡çŠ¶ï¼š**
```bash
# åªç›‘å¬å†…ç½‘IPï¼Œä¸ç›‘å¬æ‰€æœ‰æ¥å£
tcp  172.x.x.x:3478  LISTEN  âŒ
tcp  127.0.0.1:3478  LISTEN  âŒ
# åº”è¯¥æ˜¯ï¼š
tcp  0.0.0.0:3478    LISTEN  âœ…
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# ä½¿ç”¨è‡ªåŠ¨ä¿®å¤è„šæœ¬
sudo bash fix_coturn.sh

# æˆ–æ‰‹åŠ¨ä¿®å¤
sudo systemctl stop coturn
sudo nano /etc/turnserver.conf
# ç¡®ä¿åŒ…å«: listening-ip=0.0.0.0

# æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•
sudo turnserver -c /etc/turnserver.conf -v
```

### é—®é¢˜3ï¼šæ‰‹æœºæ˜¨å¤©èƒ½ç”¨ï¼Œä»Šå¤©çªç„¶ä¸è¡Œ

**åŸå› ï¼š** å…è´¹TURNæœåŠ¡å™¨ä¸ç¨³å®š

**è§£å†³æ–¹æ¡ˆï¼š**
```yaml
# é…ç½®å¤šä¸ªå¤‡ç”¨TURNæœåŠ¡å™¨
turn_config:
  urls: 
    - "stun:stun.l.google.com:19302"
    - "turn:YOUR-CLOUD-SERVER-IP:3478"     # è‡ªå»ºTURN (ä¸»è¦)
    - "turn:openrelay.metered.ca:80"       # å…è´¹å¤‡ç”¨
    - "turn:numb.viagenie.ca"              # å…è´¹å¤‡ç”¨
  username: "username"
  credential: "password"
```

### é—®é¢˜4ï¼šWebRTCè¿æ¥å¤±è´¥è¯Šæ–­

**ä½¿ç”¨æµè§ˆå™¨è°ƒè¯•ï¼š**
1. æ‰“å¼€ `chrome://webrtc-internals/`
2. æŸ¥çœ‹è¿æ¥çŠ¶æ€ï¼š
   ```
   âœ… æˆåŠŸ: ICE connection state: connected
   âŒ å¤±è´¥: ICE connection state: failed
   ```

**åœ¨çº¿æµ‹è¯•å·¥å…·ï¼š**
- è®¿é—®ï¼šhttps://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/
- è¾“å…¥ä½ çš„TURNæœåŠ¡å™¨ä¿¡æ¯æµ‹è¯•è¿é€šæ€§

---

## ğŸ’° æˆæœ¬å¯¹æ¯”åˆ†æ

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æœˆæˆæœ¬ | ç¨³å®šæ€§ | é…ç½®éš¾åº¦ | æ¨èåº¦ |
|------|--------|--------|----------|--------|
| å…è´¹TURN | Â¥0 | â­â­ | ç®€å• | â­â­ |
| è‡ªå»ºTURN | Â¥30-50 | â­â­â­â­â­ | ä¸­ç­‰ | â­â­â­â­â­ |
| å•†ä¸šTURN | Â¥100+ | â­â­â­â­â­ | ç®€å• | â­â­â­ |

### æ¨èæ–¹æ¡ˆ

**ä¸ªäººå­¦ä¹ /æµ‹è¯•ï¼š** è‡ªå»ºTURN (é˜¿é‡Œäº‘å…è´¹è¯•ç”¨)
**å°å‹é¡¹ç›®ï¼š** è‡ªå»ºTURN (1æ ¸1Gäº‘æœåŠ¡å™¨)
**å•†ä¸šé¡¹ç›®ï¼š** å•†ä¸šTURNæœåŠ¡

---

## ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

**ç¬¬ä¸€é˜¶æ®µï¼šæœ¬åœ°å‡†å¤‡**
- [ ] SSLè¯ä¹¦å·²ç”Ÿæˆ
- [ ] æœåŠ¡é…ç½®hostæ”¹ä¸º`0.0.0.0`
- [ ] å†…ç½‘ç©¿é€å·¥å…·é…ç½®æ­£ç¡®ï¼ˆTCPåè®®ï¼‰
- [ ] æœ¬åœ°å¯ä»¥é€šè¿‡ `https://127.0.0.1:8282` è®¿é—®

**ç¬¬äºŒé˜¶æ®µï¼šäº‘æœåŠ¡å™¨**
- [ ] äº‘æœåŠ¡å™¨å·²è´­ä¹°å¹¶è·å¾—å…¬ç½‘IP
- [ ] é˜²ç«å¢™ç«¯å£å·²å¼€æ”¾ (3478, 49152-65535)
- [ ] coturnå·²å®‰è£…å¹¶æ­£ç¡®é…ç½®
- [ ] coturnç›‘å¬åœ¨ `0.0.0.0:3478`

**ç¬¬ä¸‰é˜¶æ®µï¼šé›†æˆæµ‹è¯•**
- [ ] é¡¹ç›®é…ç½®å·²æ›´æ–°TURNæœåŠ¡å™¨åœ°å€
- [ ] å¯åŠ¨æ—¥å¿—æ˜¾ç¤ºTURNæœåŠ¡å™¨é…ç½®æˆåŠŸ
- [ ] å…¬ç½‘ç•Œé¢è®¿é—®æ­£å¸¸
- [ ] **æ•°å­—äººæ˜¾ç¤ºæ­£å¸¸** (å…³é”®æµ‹è¯•)
- [ ] **è¯­éŸ³å¯¹è¯åŠŸèƒ½æ­£å¸¸** (å…³é”®æµ‹è¯•)

**ç¬¬å››é˜¶æ®µï¼šç§»åŠ¨ç«¯éªŒè¯**
- [ ] æ‰‹æœºWiFiç¯å¢ƒæµ‹è¯•é€šè¿‡
- [ ] æ‰‹æœºç§»åŠ¨æ•°æ®ç½‘ç»œæµ‹è¯•é€šè¿‡
- [ ] ä¸åŒå“ç‰Œæ‰‹æœºæµ‹è¯•é€šè¿‡

---

## ğŸ¯ æœ€ä½³å®è·µå»ºè®®

### 1. ç¨³å®šæ€§ä¼˜åŒ–
```yaml
# æ¨èçš„TURNé…ç½® - ä¸»å¤‡ç»“åˆ
turn_config:
  urls:
    - "stun:stun.l.google.com:19302"           # Google STUN
    - "turn:YOUR-CLOUD-SERVER-IP:3478"         # è‡ªå»ºTURN (ä¸»)
    - "turn:openrelay.metered.ca:80"           # å…è´¹å¤‡ç”¨
    - "turn:numb.viagenie.ca"                  # å…è´¹å¤‡ç”¨
  username: "username"
  credential: "password"
```

### 2. ç›‘æ§å’Œç»´æŠ¤
```bash
# å®šæœŸæ£€æŸ¥TURNæœåŠ¡å™¨çŠ¶æ€
sudo systemctl status coturn
sudo netstat -tulpn | grep 3478

# æŸ¥çœ‹coturnæ—¥å¿—
sudo journalctl -u coturn -f
```

### 3. æˆæœ¬ä¼˜åŒ–
- **ä¸ªäººä½¿ç”¨**ï¼šé˜¿é‡Œäº‘ECSå…è´¹è¯•ç”¨ + è‡ªå»ºTURN
- **é•¿æœŸä½¿ç”¨**ï¼šé€‰æ‹©åˆé€‚é…ç½®çš„äº‘æœåŠ¡å™¨ï¼ˆ1æ ¸1Gè¶³å¤Ÿï¼‰
- **é«˜å¹¶å‘**ï¼šå‡çº§å¸¦å®½è€Œä¸æ˜¯CPU/å†…å­˜

---

## ğŸ‰ æˆåŠŸéƒ¨ç½²æ ‡å¿—

å½“çœ‹åˆ°ä»¥ä¸‹æƒ…å†µæ—¶ï¼Œè¯´æ˜éƒ¨ç½²å®Œå…¨æˆåŠŸï¼š

### **ğŸ”¥ å…³é”®éªŒè¯æ­¥éª¤ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰**

**1. é˜²ç«å¢™è¿é€šæ€§æµ‹è¯•ï¼ˆç¬¬ä¸€è¦åŠ¡ï¼‰**
```powershell
Test-NetConnection -ComputerName YOUR-SERVER-IP -Port 3478
# ç»“æœ: TcpTestSucceeded : True âœ…
```

**2. TURNæœåŠ¡å™¨éªŒè¯è„šæœ¬**
```bash
sudo bash verify_turn_setup.sh
# ç»“æœ: âœ… é€šè¿‡é¡¹ç›®: 13, âŒ å¤±è´¥é¡¹ç›®: 0
```

**3. WebRTCè¿æ¥çŠ¶æ€**
- è®¿é—® `chrome://webrtc-internals/`
- æŸ¥çœ‹ï¼š`ICE connection state: connected` âœ…
- å­˜åœ¨ï¼š`candidateType: relay` (TURNä¸­ç»§å·¥ä½œ) âœ…

**4. å®é™…åŠŸèƒ½æµ‹è¯•**
- âœ… **æœ¬åœ°æµ‹è¯•**ï¼š`https://127.0.0.1:8282/ui/index.html` æ•°å­—äººæ˜¾ç¤º
- âœ… **å…¬ç½‘æµ‹è¯•**ï¼š`https://your-domain.com:port/ui/index.html` æ•°å­—äººæ˜¾ç¤º  
- âœ… **æ‰‹æœºWiFi**ï¼šæ•°å­—äººæ˜¾ç¤ºï¼Œè¯­éŸ³å¯¹è¯æ­£å¸¸
- âœ… **æ‰‹æœºç§»åŠ¨ç½‘ç»œ**ï¼šæ•°å­—äººæ˜¾ç¤ºï¼Œè¯­éŸ³å¯¹è¯æ­£å¸¸

### **ğŸ¯ æŠ€æœ¯æŒ‡æ ‡ç¡®è®¤**

**äº‘æœåŠ¡å™¨ç«¯ï¼š**
```bash
# ç«¯å£ç›‘å¬çŠ¶æ€
sudo netstat -tulpn | grep 3478
# æœŸæœ›ç»“æœï¼š
tcp  0.0.0.0:3478  LISTEN âœ…
udp  0.0.0.0:3478         âœ…

# coturnæ—¥å¿—æœ‰å®¢æˆ·ç«¯è¿æ¥
sudo journalctl -u coturn -n 10
# æœŸæœ›çœ‹åˆ°ï¼šCREATE_PERMISSION processed, success
```

**æœ¬åœ°é¡¹ç›®ç«¯ï¼š**
```
# å¯åŠ¨æ—¥å¿—
INFO | service.rtc_service.rtc_provider - TURN servers configured: X servers âœ…
INFO | Service will be started on 0.0.0.0:8282 âœ…
```

---

## ğŸ“ æ•…éšœæ’é™¤

### **ğŸš¨ ç´§æ€¥æ’æŸ¥é¡ºåºï¼ˆ99%çš„é—®é¢˜åœ¨å‰2æ­¥ï¼‰**

**ç¬¬1æ­¥ï¼šé˜²ç«å¢™è¿é€šæ€§ï¼ˆç¬¬ä¸€è¦åŠ¡ï¼ï¼‰**
```powershell
# æœ¬åœ°PowerShellæµ‹è¯•
Test-NetConnection -ComputerName YOUR-SERVER-IP -Port 3478

# å¦‚æœ TcpTestSucceeded : False
# ç«‹å³æ£€æŸ¥äº‘æœåŠ¡å™¨å®‰å…¨ç»„é…ç½®ï¼
```

**ç¬¬2æ­¥ï¼šTURNæœåŠ¡å™¨çŠ¶æ€éªŒè¯**
```bash
# SSHåˆ°äº‘æœåŠ¡å™¨
ssh admin@YOUR-SERVER-IP

# è¿è¡Œå…¨é¢éªŒè¯
sudo bash verify_turn_setup.sh

# å¦‚æœæœ‰å¤±è´¥é¡¹ç›®ï¼Œè¿è¡Œä¿®å¤
sudo bash fix_coturn.sh
```

### **ğŸ“‹ ç³»ç»ŸåŒ–æ’æŸ¥æµç¨‹**

**å¦‚æœå‰2æ­¥éƒ½æ­£å¸¸ï¼Œä½†ä»æœ‰é—®é¢˜ï¼ŒæŒ‰é¡ºåºæ£€æŸ¥ï¼š**

3. **æ£€æŸ¥å†…ç½‘ç©¿é€**ï¼šç•Œé¢èƒ½å¦æ­£å¸¸è®¿é—®
4. **æ£€æŸ¥é¡¹ç›®é…ç½®**ï¼šTURNæœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®
5. **ä½¿ç”¨è°ƒè¯•å·¥å…·**ï¼š`chrome://webrtc-internals/` è¯Šæ–­è¿æ¥
6. **æ£€æŸ¥æœ¬åœ°é¡¹ç›®æ—¥å¿—**ï¼šæ˜¯å¦æ˜¾ç¤ºTURNé…ç½®æˆåŠŸ

### **âš¡ å¿«é€Ÿä¿®å¤å‘½ä»¤**

**ä¸€é”®éªŒè¯å’Œä¿®å¤ï¼š**
```bash
# åœ¨äº‘æœåŠ¡å™¨è¿è¡Œ
sudo bash verify_turn_setup.sh && echo "éªŒè¯å®Œæˆ" || sudo bash fix_coturn.sh
```

**è®°ä½ï¼š99%çš„WebRTCè¿æ¥å¤±è´¥éƒ½æ˜¯é˜²ç«å¢™é—®é¢˜ï¼ä¼˜å…ˆæ£€æŸ¥å®‰å…¨ç»„é…ç½®ï¼**

---

## ğŸ“‹ é™„å½•Aï¼šå®Œæ•´éªŒè¯è„šæœ¬

**verify_turn_setup.sh å®Œæ•´å†…å®¹ï¼š**

```bash
#!/bin/bash

echo "ğŸ” OpenAvatarChat TURNæœåŠ¡å™¨å…¨é¢éªŒè¯è„šæœ¬"
echo "=========================================="
echo ""

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# éªŒè¯ç»“æœç»Ÿè®¡
PASS_COUNT=0
FAIL_COUNT=0

# éªŒè¯å‡½æ•°
check_pass() {
    echo -e "âœ… ${GREEN}[PASS]${NC} $1"
    ((PASS_COUNT++))
}

check_fail() {
    echo -e "âŒ ${RED}[FAIL]${NC} $1"
    ((FAIL_COUNT++))
}

check_warn() {
    echo -e "âš ï¸ ${YELLOW}[WARN]${NC} $1"
}

check_info() {
    echo -e "â„¹ï¸ ${BLUE}[INFO]${NC} $1"
}

echo "ğŸ” ç¬¬1æ­¥ï¼šç³»ç»Ÿç¯å¢ƒæ£€æŸ¥"
echo "========================"

# è·å–IPä¿¡æ¯
PRIVATE_IP=$(ip route get 8.8.8.8 | awk '{print $7; exit}')
PUBLIC_IP=$(curl -s --connect-timeout 5 ifconfig.me || curl -s --connect-timeout 5 ipinfo.io/ip || echo "æ— æ³•è·å–")

check_info "å†…ç½‘IP: $PRIVATE_IP"
check_info "å…¬ç½‘IP: $PUBLIC_IP"

if [[ "$PUBLIC_IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    check_pass "å…¬ç½‘IPè·å–æˆåŠŸ: $PUBLIC_IP"
else
    check_fail "æ— æ³•è·å–å…¬ç½‘IP"
fi

echo ""
echo "ğŸ” ç¬¬2æ­¥ï¼šcoturnè¿›ç¨‹æ£€æŸ¥"
echo "========================"

# æ£€æŸ¥coturnè¿›ç¨‹
COTURN_PROCESS=$(ps aux | grep turnserver | grep -v grep)
if [ -n "$COTURN_PROCESS" ]; then
    check_pass "coturnè¿›ç¨‹æ­£åœ¨è¿è¡Œ"
    check_info "è¿›ç¨‹ä¿¡æ¯: $COTURN_PROCESS"
    
    # æå–ä½¿ç”¨çš„é…ç½®æ–‡ä»¶
    CONFIG_FILE=$(echo "$COTURN_PROCESS" | grep -o '\-c [^ ]*' | awk '{print $2}')
    if [ -n "$CONFIG_FILE" ]; then
        check_pass "ä½¿ç”¨é…ç½®æ–‡ä»¶: $CONFIG_FILE"
    else
        check_warn "æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶å‚æ•°"
    fi
else
    check_fail "coturnè¿›ç¨‹æœªè¿è¡Œ"
fi

echo ""
echo "ğŸ” ç¬¬3æ­¥ï¼šç«¯å£ç›‘å¬æ£€æŸ¥"
echo "======================"

# æ£€æŸ¥3478ç«¯å£ç›‘å¬
PORT_LISTEN=$(netstat -tulpn | grep :3478)
if [ -n "$PORT_LISTEN" ]; then
    check_pass "3478ç«¯å£æ­£åœ¨ç›‘å¬"
    echo "$PORT_LISTEN" | while read line; do
        check_info "ç›‘å¬è¯¦æƒ…: $line"
    done
    
    # æ£€æŸ¥æ˜¯å¦ç›‘å¬0.0.0.0
    if echo "$PORT_LISTEN" | grep "0.0.0.0:3478" > /dev/null; then
        check_pass "æ­£ç¡®ç›‘å¬æ‰€æœ‰æ¥å£ (0.0.0.0:3478)"
    else
        check_fail "æœªç›‘å¬æ‰€æœ‰æ¥å£ï¼Œå¯èƒ½åªç›‘å¬å†…ç½‘IP"
    fi
else
    check_fail "3478ç«¯å£æœªç›‘å¬"
fi

echo ""
echo "ğŸ” ç¬¬4æ­¥ï¼šé…ç½®æ–‡ä»¶éªŒè¯"
echo "======================"

# æ£€æŸ¥é…ç½®æ–‡ä»¶
ACTIVE_CONFIG="/etc/turnserver.conf"
if [ -f "$ACTIVE_CONFIG" ]; then
    check_pass "é…ç½®æ–‡ä»¶å­˜åœ¨: $ACTIVE_CONFIG"
    
    # æ£€æŸ¥å…³é”®é…ç½®é¡¹
    if grep -q "listening-ip=0.0.0.0" "$ACTIVE_CONFIG"; then
        check_pass "listening-ip é…ç½®æ­£ç¡®"
    else
        check_fail "listening-ip æœªè®¾ç½®ä¸º 0.0.0.0"
    fi
    
    if grep -q "external-ip=$PUBLIC_IP" "$ACTIVE_CONFIG"; then
        check_pass "external-ip é…ç½®æ­£ç¡®: $PUBLIC_IP"
    else
        check_warn "external-ip å¯èƒ½ä¸åŒ¹é…å½“å‰å…¬ç½‘IP"
    fi
    
    if grep -q "relay-ip=$PRIVATE_IP" "$ACTIVE_CONFIG"; then
        check_pass "relay-ip é…ç½®æ­£ç¡®: $PRIVATE_IP"
    else
        check_warn "relay-ip å¯èƒ½ä¸åŒ¹é…å½“å‰å†…ç½‘IP"
    fi
    
    if grep -q "user=username:password" "$ACTIVE_CONFIG"; then
        check_pass "TURNç”¨æˆ·è®¤è¯é…ç½®å­˜åœ¨"
    else
        check_fail "TURNç”¨æˆ·è®¤è¯é…ç½®ç¼ºå¤±"
    fi
    
    echo ""
    check_info "å½“å‰é…ç½®æ–‡ä»¶å†…å®¹:"
    echo "-----------------------------------"
    cat "$ACTIVE_CONFIG" | sed 's/^/    /'
    echo "-----------------------------------"
    
else
    check_fail "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $ACTIVE_CONFIG"
fi

echo ""
echo "ğŸ” ç¬¬5æ­¥ï¼šç½‘ç»œè¿æ¥æ€§æµ‹è¯•"
echo "========================"

# æµ‹è¯•æœ¬åœ°ç«¯å£è¿æ¥
if timeout 3 bash -c "</dev/tcp/127.0.0.1/3478" 2>/dev/null; then
    check_pass "æœ¬åœ°TCP 3478ç«¯å£è¿æ¥æˆåŠŸ"
else
    check_fail "æœ¬åœ°TCP 3478ç«¯å£è¿æ¥å¤±è´¥"
fi

# æµ‹è¯•å…¬ç½‘ç«¯å£è¿æ¥ï¼ˆä»å†…éƒ¨ï¼‰
if timeout 3 bash -c "</dev/tcp/$PUBLIC_IP/3478" 2>/dev/null; then
    check_pass "å…¬ç½‘IP TCP 3478ç«¯å£è¿æ¥æˆåŠŸ"
else
    check_fail "å…¬ç½‘IP TCP 3478ç«¯å£è¿æ¥å¤±è´¥"
fi

echo ""
echo "ğŸ” ç¬¬6æ­¥ï¼šé˜²ç«å¢™çŠ¶æ€æ£€æŸ¥"
echo "========================"

# æ£€æŸ¥ç³»ç»Ÿé˜²ç«å¢™
if command -v firewall-cmd &> /dev/null; then
    if firewall-cmd --state 2>/dev/null | grep -q "running"; then
        check_info "ç³»ç»Ÿé˜²ç«å¢™æ­£åœ¨è¿è¡Œ"
        
        OPEN_PORTS=$(firewall-cmd --list-ports 2>/dev/null || echo "æ— æ³•æŸ¥è¯¢")
        check_info "å¼€æ”¾ç«¯å£: $OPEN_PORTS"
        
        if echo "$OPEN_PORTS" | grep -q "3478"; then
            check_pass "é˜²ç«å¢™å·²å¼€æ”¾3478ç«¯å£"
        else
            check_warn "é˜²ç«å¢™å¯èƒ½æœªå¼€æ”¾3478ç«¯å£"
        fi
    else
        check_info "ç³»ç»Ÿé˜²ç«å¢™æœªè¿è¡Œ"
    fi
else
    check_info "æœªå®‰è£…firewall-cmdï¼Œè·³è¿‡ç³»ç»Ÿé˜²ç«å¢™æ£€æŸ¥"
fi

echo ""
echo "ğŸ” ç¬¬7æ­¥ï¼šWebRTCé…ç½®åŒ¹é…æ€§æ£€æŸ¥"
echo "=============================="

# æ£€æŸ¥æœ¬åœ°é¡¹ç›®é…ç½®æ–‡ä»¶åº”è¯¥æŒ‡å‘çš„TURNæœåŠ¡å™¨
EXPECTED_TURN_URL="turn:$PUBLIC_IP:3478"
check_info "æœŸæœ›çš„æœ¬åœ°é¡¹ç›®TURNé…ç½®: $EXPECTED_TURN_URL"
check_info "æœŸæœ›çš„ç”¨æˆ·å/å¯†ç : username/password"

echo ""
echo "ğŸ“Š éªŒè¯ç»“æœæ±‡æ€»"
echo "================"
echo -e "âœ… ${GREEN}é€šè¿‡é¡¹ç›®: $PASS_COUNT${NC}"
echo -e "âŒ ${RED}å¤±è´¥é¡¹ç›®: $FAIL_COUNT${NC}"

if [ $FAIL_COUNT -eq 0 ]; then
    echo ""
    echo -e "ğŸ‰ ${GREEN}æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼TURNæœåŠ¡å™¨é…ç½®å®Œç¾ï¼${NC}"
    echo ""
    echo "ğŸ“± ç°åœ¨å¯ä»¥è¿›è¡Œæ‰‹æœºæµ‹è¯•ï¼š"
    echo "   URL: https://liao.uunat.com:8282/ui/index.html"
    echo ""
    echo "ğŸ”— æœ¬åœ°é¡¹ç›®åº”ä½¿ç”¨çš„é…ç½®ï¼š"
    echo "   urls: [\"stun:stun.l.google.com:19302\", \"turn:$PUBLIC_IP:3478\"]"
    echo "   username: \"username\""
    echo "   credential: \"password\""
elif [ $FAIL_COUNT -le 2 ]; then
    echo ""
    echo -e "âš ï¸ ${YELLOW}å¤§éƒ¨åˆ†æ£€æŸ¥é€šè¿‡ï¼Œæœ‰å°‘é‡é—®é¢˜éœ€è¦ä¿®å¤${NC}"
    echo "è¯·æŸ¥çœ‹ä¸Šé¢çš„å¤±è´¥é¡¹ç›®å¹¶è¿›è¡Œä¿®å¤"
else
    echo ""
    echo -e "âŒ ${RED}å­˜åœ¨å¤šä¸ªä¸¥é‡é—®é¢˜ï¼Œéœ€è¦é‡æ–°é…ç½®${NC}"
    echo "å»ºè®®è¿è¡Œä¿®å¤è„šæœ¬: sudo bash fix_coturn.sh"
fi

echo ""
echo "ğŸ”§ å¦‚éœ€ä¿®å¤ï¼Œå¯è¿è¡Œï¼š"
echo "   sudo bash fix_coturn.sh"
echo ""
echo "ğŸ” éªŒè¯å®Œæˆï¼"
```

---

## ğŸ“‹ é™„å½•Bï¼šæˆåŠŸéƒ¨ç½²æ¡ˆä¾‹

**çœŸå®æˆåŠŸéƒ¨ç½²è®°å½•ï¼š**

**ç¯å¢ƒä¿¡æ¯ï¼š**
- äº‘æœåŠ¡å™¨ï¼šé˜¿é‡Œäº‘ECSï¼ˆ1æ ¸2Gï¼‰
- ç³»ç»Ÿï¼šCentOS 7.9
- å…¬ç½‘IPï¼š8.138.87.249
- å†…ç½‘IPï¼š172.18.57.220

**éªŒè¯ç»“æœï¼š**
```
ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼TURNæœåŠ¡å™¨é…ç½®å®Œç¾ï¼
âœ… é€šè¿‡é¡¹ç›®: 13
âŒ å¤±è´¥é¡¹ç›®: 0
```

**å…³é”®é…ç½®æ–‡ä»¶ï¼š**
```bash
# /etc/turnserver.conf
listening-port=3478
listening-ip=0.0.0.0
relay-ip=172.18.57.220
external-ip=8.138.87.249
min-port=49152
max-port=65535
verbose
fingerprint
lt-cred-mech
user=username:password
realm=turn.8-138-87-249.turnserver
```

**å®‰å…¨ç»„è§„åˆ™ï¼š**
```
TCP  3478         0.0.0.0/0    TURN TCPç«¯å£
UDP  3478         0.0.0.0/0    TURN UDPç«¯å£  
UDP  49152/65535  0.0.0.0/0    WebRTCåª’ä½“ç«¯å£
```

**æœ€ç»ˆæµ‹è¯•ç»“æœï¼š**
- âœ… æ‰‹æœºWiFiç½‘ç»œï¼šæ•°å­—äººæ˜¾ç¤ºæ­£å¸¸ï¼Œè¯­éŸ³å¯¹è¯å·¥ä½œ
- âœ… æ‰‹æœºç§»åŠ¨ç½‘ç»œï¼šæ•°å­—äººæ˜¾ç¤ºæ­£å¸¸ï¼Œè¯­éŸ³å¯¹è¯å·¥ä½œ
- âœ… ä¸åŒè®¾å¤‡ï¼šå¤šå°æ‰‹æœºæµ‹è¯•é€šè¿‡
- âœ… WebRTCçŠ¶æ€ï¼šICE connection state: connected

---

*æœ¬æŒ‡å—åŸºäº**çœŸå®æˆåŠŸéƒ¨ç½²ç»éªŒ**ç¼–å†™ï¼Œæ¶µç›–äº†æ‰€æœ‰å®é™…é‡åˆ°çš„å‘ç‚¹å’Œè§£å†³æ–¹æ¡ˆã€‚ç‰¹åˆ«æ„Ÿè°¢é˜²ç«å¢™é…ç½®è¿™ä¸ªæœ€å¤§çš„å‘ï¼*